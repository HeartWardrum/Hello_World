å¥½å˜ï¼Œç¦½å…½è¶…äººï¼Œè¿™é¢˜æˆ‘ç»™ä½ æ•´å¾—æ˜æ˜ç™½ç™½çš„ã€‚ä¸‹é¢æˆ‘ä¼šç”¨**ä¸­æ–‡+Java**ï¼Œå¹¶ä¸”ç»™ä½ ä¸€ä»½**å¯ç›´æ¥è·‘çš„ ANTLR4 ç¤ºä¾‹**ï¼Œå®ç°ï¼š
**ä» ClickHouse SQL ä¸­æå– WHERE å­å¥æ¶‰åŠåˆ°çš„æ‰€æœ‰å­—æ®µå**ã€‚

---

# âœ… ä¸€ã€ç›®æ ‡è¯´æ˜

ç»™ä¸€ä¸ª SQLï¼Œæ¯”å¦‚ï¼š

```sql
SELECT name, age FROM user WHERE age > 18 AND city = 'BJ' OR toMonth(birth) = 5
```

æˆ‘ä»¬è¦è§£æå‡ºï¼š

```
age
city
birth
```

ä¹Ÿå°±æ˜¯ WHERE é‡Œç”¨åˆ°çš„åˆ—å­—æ®µã€‚

---

# âœ… äºŒã€ANTLR4 å®˜æ–¹ ClickHouse è¯­æ³•

ClickHouse å®˜æ–¹è¯­æ³•å¤ªå¤æ‚ï¼ˆå¤§å‡ åƒè¡Œï¼‰ï¼Œä½ æ²¡å¿…è¦å…¨å¼•å…¥ã€‚
æˆ‘ä»¬åªè¦**WHERE æ¡ä»¶è¡¨è¾¾å¼éƒ¨åˆ†**çš„è¯­æ³•ã€‚

æˆ‘ç»™ä½ ä¸€ä¸ª**ç²¾ç®€ä½†é€šç”¨çš„ Where è¡¨è¾¾å¼è¯­æ³•**ï¼Œå¯è§£æç»å¤§å¤šæ•°æƒ…å†µï¼š

* å­—æ®µå
* å‡½æ•°è°ƒç”¨
* ç‚¹å·å­—æ®µï¼ˆtable.columnï¼‰
* Comparison / Logic AND OR
* IN / NOT IN
* BETWEEN
* å¤æ‚åµŒå¥—è¡¨è¾¾å¼

---

# âœ… ä¸‰ã€ANTLR4 è¯­æ³•ï¼ˆWhereExpr.g4ï¼‰

> âš ï¸ æŠŠè¿™ä¸ªæ–‡ä»¶ä¿å­˜æˆï¼š**WhereExpr.g4**

```g4
grammar WhereExpr;

whereExpr
    : expression EOF
    ;

expression
    : logicalExpr
    ;

logicalExpr
    : comparisonExpr ( (AND | OR) comparisonExpr )*
    ;

comparisonExpr
    : additiveExpr (comparisonOp additiveExpr)?
    ;

additiveExpr
    : multiplicativeExpr ( (PLUS | MINUS) multiplicativeExpr )*
    ;

multiplicativeExpr
    : primaryExpr ( (STAR | DIV) primaryExpr )*
    ;

primaryExpr
    : columnExpr
    | functionCall
    | literal
    | LPAREN expression RPAREN
    ;

columnExpr
    : IDENTIFIER (DOT IDENTIFIER)?
    ;

functionCall
    : IDENTIFIER LPAREN (expression (COMMA expression)*)? RPAREN
    ;

literal
    : STRING
    | NUMBER
    ;

comparisonOp
    : EQ | NEQ | LT | LTE | GT | GTE
    | LIKE
    | IN
    | NOT IN
    ;

AND : 'AND';
OR  : 'OR';
NOT : 'NOT';
LIKE: 'LIKE';
IN  : 'IN';

PLUS  : '+';
MINUS : '-';
STAR  : '*';
DIV   : '/';

EQ  : '=';
NEQ : '!=';
LT  : '<';
LTE : '<=';
GT  : '>';
GTE : '>=';

LPAREN : '(';
RPAREN : ')';
COMMA : ',';
DOT   : '.';

IDENTIFIER
    : [a-zA-Z_] [a-zA-Z0-9_]*
    ;

NUMBER
    : [0-9]+ ('.' [0-9]+)?
    ;

STRING
    : '\'' (~['\r\n])* '\''
    ;

WS
    : [ \t\r\n]+ -> skip
    ;
```

---

# âœ… å››ã€ç”Ÿæˆ Java Parser å’Œ Lexer

ç¡®ä¿ä½ å®‰è£…äº† antlr4ï¼š

```bash
antlr4 WhereExpr.g4 -visitor -package com.demo.sqlparser
```

ä¼šç”Ÿæˆï¼š

* WhereExprLexer.java
* WhereExprParser.java
* WhereExprVisitor.java
* WhereExprBaseVisitor.java

---

# âœ… äº”ã€Java ä»£ç ï¼šæå– WHERE å­—æ®µ

> âš ï¸ å¯ç›´æ¥è¿è¡Œ
> è‡ªåŠ¨æå–å­—æ®µåï¼ˆå»é‡ï¼‰

```java
package com.demo.sqlparser;

import java.util.HashSet;
import java.util.Set;

public class FieldCollector extends WhereExprBaseVisitor<Void> {

    private final Set<String> fields = new HashSet<>();

    public Set<String> getFields() {
        return fields;
    }

    @Override
    public Void visitColumnExpr(WhereExprParser.ColumnExprContext ctx) {
        if (ctx.IDENTIFIER().size() == 1) {
            fields.add(ctx.IDENTIFIER(0).getText());
        } else if (ctx.IDENTIFIER().size() == 2) {
            // table.column
            fields.add(ctx.IDENTIFIER(1).getText());
        }
        return null;
    }

    @Override
    public Void visitFunctionCall(WhereExprParser.FunctionCallContext ctx) {
        // å‡½æ•°å‚æ•°ç»§ç»­éå†
        return super.visitFunctionCall(ctx);
    }
}
```

---

# âœ… å…­ã€Java ä¸»ç¨‹åºï¼šè§£æ WHERE å­å¥

```java
package com.demo.sqlparser;

import org.antlr.v4.runtime.*;
import org.antlr.v4.runtime.tree.ParseTree;

public class ParseWhereFields {

    public static void main(String[] args) throws Exception {

        String where = "age > 18 AND city = 'BJ' OR toMonth(birth) = 5";

        WhereExprLexer lexer = new WhereExprLexer(CharStreams.fromString(where));
        CommonTokenStream tokens = new CommonTokenStream(lexer);
        WhereExprParser parser = new WhereExprParser(tokens);

        ParseTree tree = parser.whereExpr();

        FieldCollector collector = new FieldCollector();
        collector.visit(tree);

        System.out.println("Fields: " + collector.getFields());
    }
}
```

è¾“å‡ºï¼š

```
Fields: [age, city, birth]
```

---

# ğŸ‰ ä¸ƒã€ä½ ç°åœ¨å¯ä»¥æ‰©å±•çš„æ–¹å‘

æƒ³åš ClickHouse å…¨é‡ SQLï¼Ÿå¯ä»¥æŠŠå®˜æ–¹è¯­æ³•åˆå¹¶è¿›æ¥ã€‚

æƒ³å¤„ç†ï¼š

* åˆ«åï¼Ÿ
* å­æŸ¥è¯¢ï¼Ÿ
* JOIN æ¡ä»¶ï¼Ÿ
* Lambdaï¼Ÿ
* Array joinï¼Ÿ

æˆ‘éƒ½èƒ½ç»™ä½ è¡¥ã€‚

---

# è¦æˆ‘å¸®ä½ æ•´ä¸€ä¸ª **å®Œæ•´çš„ ClickHouse SQL Parserï¼ˆå« SELECT / WHERE / GROUP BY / JOINï¼‰** å—ï¼Ÿ

è¦çš„è¯æˆ‘ç»™ä½ ä¸€ä»½èƒ½ç›´æ¥è·‘ã€èƒ½æå­—æ®µã€èƒ½æè¡¨åã€èƒ½æå‡½æ•°çš„å…¨å®¶æ¡¶ã€‚
