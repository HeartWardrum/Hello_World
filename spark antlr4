ä½¿ç”¨ **Listener** æˆ– **Visitor** éƒ½èƒ½è§£æ SQLï¼Œæœ¬è´¨ä¸Šæ²¡æœ‰å¯¹é”™ä¹‹åˆ†ï¼Œåªæ˜¯**ç”¨é€”ä¸åŒã€è§£æé£æ ¼ä¸åŒ**ã€‚
ä½ é—® â€œä¸ºä»€ä¹ˆä¸ç”¨ visitor è§£æ SQLï¼Ÿâ€ï¼Œæˆ‘æ¥ä» **ANTLR å·¥ä½œæœºåˆ¶ã€Spark SQL çš„è¯­æ³•ç‰¹æ€§ã€å·¥ç¨‹å®è·µ** ä¸‰æ–¹é¢è§£é‡Šï¼Œè®©ä½ ä¸€çœ¼å°±æ˜ç™½ä¸¤è€…å·®å¼‚ã€‚

---

# âœ… ä¸€å¥è¯ç»“è®º

**è§£æ SQL æ¡ä»¶è¡¨è¾¾å¼æ—¶ï¼Œç”¨ Listener æ›´è½»é‡ï¼Œç”¨ Visitor æ›´å¯æ§ã€‚**
ä¸Šé¢æˆ‘ç»™çš„ç¤ºä¾‹ç”¨ Listenerï¼Œæ˜¯å› ä¸ºå®ƒæ›´é€‚åˆ **äº‹ä»¶é©±åŠ¨å¼æ£€æµ‹ï¼ˆä¾‹å¦‚ï¼šåªè¦å‡ºç°æ•æ„Ÿå­—æ®µå°±è¿”å› trueï¼‰**ã€‚

ä½†å®é™…ä¸Šï¼š
ğŸ‘‰ **Visitor åœ¨ SQL è§£æä¸­æ›´å¸¸è§ï¼Œä¹Ÿæ›´é€‚åˆå¤æ‚è§„åˆ™åˆ†æ**ã€‚

å¦‚æœä½ çš„è§„åˆ™ä»¥åè¦æ‰©å±•ï¼Œæˆ‘åè€Œæ¨èæ”¹ç”¨ Visitorã€‚

---

# ğŸ“Œ Listener vs Visitor çš„å…³é”®åŒºåˆ«

| ç‰¹ç‚¹   | Listenerï¼ˆç›‘å¬å™¨ï¼‰    | Visitorï¼ˆè®¿é—®å™¨ï¼‰      |
| ---- | ---------------- | ----------------- |
| è§¦å‘æ–¹å¼ | äº‹ä»¶å›è°ƒï¼ˆenter/exitï¼‰ | æ‰‹åŠ¨æ§åˆ¶è®¿é—®è¿‡ç¨‹          |
| æ§åˆ¶åŠ›  | è¢«åŠ¨ï¼Œè¿›å…¥èŠ‚ç‚¹å°±è§¦å‘       | ä¸»åŠ¨ï¼Œæƒ³è®¿é—®è°è®¿é—®è°        |
| é€‚åˆç”¨é€” | ç®€å•éå†ã€æ¨¡å¼åŒ¹é…ã€æ£€æµ‹å­—æ®µ   | è¡¨è¾¾å¼æ±‚å€¼ã€AST æ„é€ ã€å¤æ‚åˆ†æ |
| ä»£ç ç»“æ„ | ä½ä¾µå…¥ï¼Œä½†é€»è¾‘åˆ†æ•£åœ¨å¤šä¸ªæ–¹æ³•   | ç»“æ„åŒ–å¼ºï¼Œå¯é›†ä¸­å¤„ç†è¡¨è¾¾å¼     |
| æ€§èƒ½   | å¿«ï¼Œéå†ä¸€æ¬¡           | å¯è£å‰ªï¼Œä¸å¿…å…¨éå†         |

---

# ğŸ§  ä¸ºä»€ä¹ˆç¤ºä¾‹é‡Œæˆ‘ç”¨ Listenerï¼Ÿ

ä½ çš„æ ¸å¿ƒéœ€æ±‚æ˜¯ï¼š

> åˆ¤æ–­ WHERE/HAVING æ˜¯å¦åŒ…å«æ•æ„Ÿå­—æ®µ

è¿™ç±»é€»è¾‘æ˜¯å…¸å‹çš„**äº‹ä»¶å‹åŒ¹é…**ï¼š

* å‡ºç°åˆ—å â†’ åˆ¤æ–­æ˜¯å¦æ•æ„Ÿ
* åŒ¹é…åˆ°æ•æ„Ÿå­—æ®µå³å¯æå‰ç»“æŸ
* ä¸éœ€è¦æ„å»º AST
* ä¸éœ€è¦å¯¹è¡¨è¾¾å¼æ±‚å€¼
* ä¸éœ€è¦å¯¹ SQL é€»è¾‘æ•´ä½“å»ºæ¨¡

Listener åœ¨è¿™ç§åœºæ™¯é‡Œæ˜æ˜¾æ›´è½»ï¼š

```java
@Override
public void enterColumnReference(Context ctx) {
    if (sensitiveFields.contains(ctx.getText())) {
        hasSensitive = true;
    }
}
```

ç®€å•ç›´æ¥ï¼Œä¸éœ€è¦æ§åˆ¶éå†æµç¨‹ã€‚

---

# ğŸ§  ä¸ºä»€ä¹ˆæœ‰äº›äººæ›´å–œæ¬¢ Visitorï¼Ÿ

Visitor æ›´åƒæ‰‹å†™ AST è§£æå™¨ï¼Œä¼˜åŠ¿éå¸¸å¤§ï¼š

### âœ” 1. é¿å…éå†æ•´ä¸ªæ ‘ï¼ˆæ›´å¿«ï¼‰

ä½ å¯ä»¥åªè®¿é—® WHERE å­æ ‘ï¼š

```java
visit(ctx.whereClause());
```

Listener ä¸è¡Œï¼Œå®ƒå¿…é¡»éå†æ•´ä¸ªè¯­æ³•æ ‘ã€‚

### âœ” 2. æ ‘èŠ‚ç‚¹åˆ†ç±»æ¸…æ™°

ä¾‹å¦‚ï¼š

* visitBooleanExpression
* visitComparison
* visitLogicalOperator
* visitColumnReference

æ‰€æœ‰è§£æé€»è¾‘é›†ä¸­åœ¨ä¸€ä¸ªç±»é‡Œï¼Œéå¸¸é€‚åˆå¤æ‚è§„åˆ™ã€‚

### âœ” 3. æ›´é€‚åˆå°† SQL è½¬æ¢æˆå†…éƒ¨è¡¨è¾¾å¼å¯¹è±¡ï¼ˆASTï¼‰

å¦‚æœä½ è¦åšï¼š

* SQL é»‘åå•æ£€æŸ¥
* SQL è½¬ Java Predicate
* SQL è¯­ä¹‰åˆ†æ

Visitor æ˜æ˜¾æ›´ä¸“ä¸šã€‚

---

# ğŸ”¥ Visitor ç‰ˆçš„æ•æ„Ÿå­—æ®µæ£€æµ‹ï¼ˆä½ å¯èƒ½æ›´å–œæ¬¢ï¼‰

```java
public class SensitiveFieldVisitor extends SparkSqlBaseBaseVisitor<Boolean> {

    private final Set<String> sensitive;

    public SensitiveFieldVisitor(Set<String> sensitive) {
        this.sensitive = sensitive;
    }

    @Override
    public Boolean visitColumnReference(SparkSqlBaseParser.ColumnReferenceContext ctx) {
        String column = ctx.getText().toLowerCase();

        if (column.contains(".")) {
            column = column.substring(column.indexOf('.') + 1);
        }

        return sensitive.contains(column);
    }

    @Override
    protected Boolean defaultResult() {
        return false;
    }

    @Override
    protected Boolean aggregateResult(Boolean aggregate, Boolean nextResult) {
        return aggregate || nextResult; // é‡åˆ°æ•æ„Ÿå­—æ®µå³å¯è¿”å› true
    }
}
```

ä½¿ç”¨ï¼š

```java
SensitiveFieldVisitor visitor = new SensitiveFieldVisitor(sensitiveFields);
boolean hasSensitive = visitor.visit(tree);
```

---

# ğŸ¯ æ€»ç»“ï¼ˆç†æ¸…ä½ åº”è¯¥æ€ä¹ˆé€‰ï¼‰

### âœ” å¦‚æœä½ åªæ˜¯åš **è½»é‡åˆ¤æ–­**

ä¾‹å¦‚ â€œWHERE é‡Œæ˜¯å¦åŒ…å«æŸå­—æ®µâ€ï¼ŒListener è¶³å¤Ÿä¸”æ›´å¿«ã€‚

### âœ” å¦‚æœä½ è¦åš **å¤æ‚ SQL è§£æ/æ”¹å†™/æŠ½è±¡è¯­æ³•åˆ†æ**

Visitor ç»å¯¹æ˜¯é¦–é€‰ã€‚

---

# ğŸ“Œ å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ç»§ç»­æä¾›ï¼š

* Visitor + Listener æ··åˆæœ€ä½³å®è·µ
* ç”Ÿäº§çº§ Spark SQL å­æŸ¥è¯¢è§£ææ–¹æ¡ˆ
* æ•æ„Ÿå­—æ®µæ£€æµ‹å¢å¼ºç‰ˆï¼ˆæ”¯æŒ UDFã€CASE WHENã€å­æŸ¥è¯¢ã€JOIN ON ç­‰ï¼‰
* è‡ªåŠ¨æå– WHERE/HAVING å­—æ®µçš„å®Œæ•´å·¥å…·ç±»

ä½ æƒ³ç»§ç»­ç”¨ Listenerï¼Œè¿˜æ˜¯å¸Œæœ›æˆ‘ç»™ä½  **Visitor ç‰ˆå®Œæ•´é¡¹ç›®æ¨¡æ¿**ï¼Ÿ
