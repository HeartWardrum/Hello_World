ä¸‹é¢ç»™ä½ ä¸€ä¸ª**å¯ç›´æ¥åœ¨ Java ä¸­ä½¿ç”¨ ANTLR 4.13.2** çš„å®Œæ•´æ€è·¯ä¸ç¤ºä¾‹ä»£ç ï¼Œç”¨æ¥**åˆ¤æ–­ Spark SQL æŸ¥è¯¢æ¡ä»¶ï¼ˆWHERE/HAVINGï¼‰ä¸­æ˜¯å¦åŒ…å«æ•æ„Ÿå­—æ®µ**ã€‚

## ğŸ§© æ€»ä½“æ€è·¯

1. **ä¸‹è½½ Spark SQL çš„ ANTLR è¯­æ³•æ–‡ä»¶**
   Spark å®˜æ–¹è¯­æ³•åœ¨ `antlr4` ä¸‹ï¼ˆspark-parserï¼‰ã€‚ä½ ä¹Ÿå¯ç”¨å¼€æºç®€åŒ–ç‰ˆæœ¬ï¼Œä¾‹å¦‚ï¼š

   ```
   SparkSqlBase.g4
   SqlBaseLexer.g4
   SqlBaseParser.g4
   ```

   ï¼ˆå¦‚æœä½ éœ€è¦ï¼Œæˆ‘å¯ä»¥ç›´æ¥ç»™ä½ è£å‰ªåçš„å¯ç”¨ g4 æ–‡ä»¶ï¼‰

2. **ä½¿ç”¨ ANTLR 4.13.2 ç”Ÿæˆè§£æå™¨**

3. åœ¨ Java ä¸­ï¼š

   * è§£æ SQL â†’ å¾—åˆ° AST
   * è‡ªå®šä¹‰ä¸€ä¸ª `ParseTreeWalker` Listener
   * åœ¨ listener ä¸­åªå¤„ç† WHERE/HAVING æ¡ä»¶è¡¨è¾¾å¼
   * æ£€æµ‹å­—æ®µåç§°æ˜¯å¦å‘½ä¸­æ•æ„Ÿå­—æ®µåˆ—è¡¨

---

# âœ… Java å®ç°ç¤ºä¾‹ï¼ˆANTLR 4.13.2ï¼‰

ä»¥ä¸‹ä»£ç åŸºäº Spark SQL å¸¸ç”¨è¯­æ³•ï¼ˆæ”¯æŒ SELECT, WHERE, AND/OR, æ¯”è¾ƒè¡¨è¾¾å¼ç­‰ï¼‰ã€‚

---

## 1ï¸âƒ£ ç›‘å¬å™¨ï¼šæ£€æµ‹æ•æ„Ÿå­—æ®µ

```java
import java.util.HashSet;
import java.util.Set;

public class SensitiveFieldListener extends SparkSqlBaseBaseListener {

    private final Set<String> sensitiveFields;
    private boolean hasSensitiveField = false;

    public SensitiveFieldListener(Set<String> sensitiveFields) {
        this.sensitiveFields = sensitiveFields;
    }

    public boolean hasSensitiveField() {
        return hasSensitiveField;
    }

    @Override
    public void enterColumnReference(SparkSqlBaseParser.ColumnReferenceContext ctx) {
        if (hasSensitiveField) return;

        String column = ctx.getText().toLowerCase();

        // å»é™¤è¡¨åˆ«åï¼Œä¾‹å¦‚ t.user_name â†’ user_name
        if (column.contains(".")) {
            column = column.substring(column.indexOf('.') + 1);
        }

        if (sensitiveFields.contains(column)) {
            hasSensitiveField = true;
        }
    }
}
```

---

## 2ï¸âƒ£ SQL æ£€æµ‹æ–¹æ³•

```java
import org.antlr.v4.runtime.*;
import org.antlr.v4.runtime.tree.*;

import java.util.Set;

public class SparkSqlSensitiveChecker {

    public static boolean containsSensitiveField(String sql, Set<String> sensitiveFields) {
        CharStream input = CharStreams.fromString(sql);

        SparkSqlBaseLexer lexer = new SparkSqlBaseLexer(input);
        CommonTokenStream tokens = new CommonTokenStream(lexer);
        SparkSqlBaseParser parser = new SparkSqlBaseParser(tokens);

        parser.removeErrorListeners(); // å¯é€‰
        parser.addErrorListener(new BaseErrorListener() {
            @Override
            public void syntaxError(Recognizer<?, ?> recognizer, Object offendingSymbol,
                                    int line, int charPositionInLine, String msg, RecognitionException e)
                    throws RuntimeException {
                throw new RuntimeException("SQLè¯­æ³•é”™è¯¯: " + msg, e);
            }
        });

        ParseTree tree = parser.singleStatement();

        SensitiveFieldListener listener = new SensitiveFieldListener(sensitiveFields);
        ParseTreeWalker.DEFAULT.walk(listener, tree);

        return listener.hasSensitiveField();
    }
}
```

---

## 3ï¸âƒ£ ä½¿ç”¨ç¤ºä¾‹

```java
import java.util.Set;

public class Demo {
    public static void main(String[] args) {
        String sql = "SELECT * FROM user WHERE id > 10 AND phone_no = '123'";

        Set<String> sensitive = Set.of("phone_no", "id_card", "bank_account");

        boolean result = SparkSqlSensitiveChecker.containsSensitiveField(sql, sensitive);

        System.out.println("æ˜¯å¦åŒ…å«æ•æ„Ÿå­—æ®µ: " + result);
    }
}
```

è¾“å‡ºï¼š

```
æ˜¯å¦åŒ…å«æ•æ„Ÿå­—æ®µ: true
```

---

# ğŸ” æ£€æµ‹èŒƒå›´æ”¯æŒ

ä¸Šè¿°æ–¹æ¡ˆèƒ½æ£€æµ‹ä»¥ä¸‹ä½ç½®æ˜¯å¦å‡ºç°æ•æ„Ÿå­—æ®µï¼š

* WHERE æ¡ä»¶ä¸­çš„ï¼š

  * `col = value`
  * `col > ...`
  * `col IN (...)`
  * `col LIKE ...`
* HAVING æ¡ä»¶
* AND/OR åµŒå¥—
* å¸¦è¡¨åˆ«åå­—æ®µ `t.col`

å¦‚ï¼š

```sql
SELECT t.id FROM user t WHERE t.phone_no LIKE '13%'
```

èƒ½å¤Ÿæ­£ç¡®è¯†åˆ« `phone_no`ã€‚

---

# ğŸ“¦ å¯æä¾›çš„å†…å®¹

å¦‚æœä½ éœ€è¦ï¼Œæˆ‘å¯ä»¥ç›´æ¥æä¾›ï¼š

âœ” ç²¾ç®€ç‰ˆ Spark SQL çš„ ANTLR g4 æ–‡ä»¶ï¼ˆå®Œå…¨èƒ½è§£æå¸¸ç”¨ SELECT + WHEREï¼‰
âœ” Maven é…ç½®ï¼ˆantlr4 æ’ä»¶ï¼‰
âœ” æ•æ„Ÿå­—æ®µè¡¨è¾¾å¼è¯†åˆ«å¢å¼ºç‰ˆï¼ˆæ”¯æŒ UDFã€CASE WHENã€å­æŸ¥è¯¢ï¼‰
âœ” åå‘è¾“å‡ºæ•æ„Ÿå­—æ®µåˆ—è¡¨ï¼Œè€Œä¸ä»…æ˜¯æ˜¯å¦å­˜åœ¨

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥æŠŠ **å®Œæ•´å¯è¿è¡Œçš„ Maven + Java + g4 æ–‡ä»¶å·¥ç¨‹** ä¸€æ¬¡æ€§æ‰“åŒ…ç»™ä½ ã€‚åªè¦å‘Šè¯‰æˆ‘ï¼š
**æ˜¯å¦éœ€è¦å®Œæ•´é¡¹ç›®ç»“æ„ï¼Ÿ**
