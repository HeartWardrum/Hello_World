ä¸‹é¢ç»™ä½ ä¸€ä¸ª**é€šç”¨ã€å¯è½åœ°ã€ä¸ ClickHouse å®˜æ–¹ ANTLR4 è¯­æ³•ä¸€è‡´**çš„åšæ³•ï¼Œç”¨ **Listener** æå– WHERE å­å¥ä¸­çš„æ‰€æœ‰å­—æ®µï¼Œå¹¶ä¸”è¿”å› **Set<String>ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ è¡¨å.å­—æ®µå æˆ– å­—æ®µå**ã€‚

ä½ é‡åˆ°çš„é—®é¢˜æ˜¯ï¼š

1. **æ²¡æœ‰ ColumnExprDot / ColumnExprField** â€”â€”è¯´æ˜ä½ é¡¹ç›®é‡Œçš„ `ClickHouseParser.g4` å¹¶ä¸æ˜¯æŸäº›åšå®¢é‡Œçš„ç‰ˆæœ¬ï¼Œè€Œæ˜¯ ClickHouse å®˜æ–¹è¯­æ³•ï¼Œç»“æ„å®Œå…¨ä¸åŒã€‚
2. ä½ åªæœ‰ **ClickHouseListenerï¼ˆListeneræ¨¡å¼ï¼‰**ï¼Œæ²¡æœ‰ Visitorï¼Œä¹Ÿæ²¡å…³ç³»ï¼ŒListener åŒæ ·èƒ½åšã€‚

---

# âœ… ä¸€ã€ClickHouse å®˜æ–¹è¯­æ³•ä¸­ ColumnExpr çš„ç»“æ„ï¼ˆé‡ç‚¹ï¼‰

åœ¨ ClickHouse å®˜æ–¹ ANTLR4 è¯­æ³•ä¸­ï¼Œâ€œå­—æ®µåâ€é€šå¸¸åœ¨ï¼š

```
clickhouse-grammar/ClickHouseParser.g4ï¼š

columnIdentifier
    : identifier (DOT identifier)*
```

æˆ–è€…åœ¨æŸäº›è¡¨è¾¾å¼é‡Œå‡ºç°ï¼š

```
columnExpr:
      identifier
    | columnIdentifier
    | tableIdentifier '.' identifier
    | ...
```

---

# âœ… äºŒã€æˆ‘ä»¬è¯¥ç›‘å¬å“ªäº›èŠ‚ç‚¹ï¼Ÿ

ä¸ºäº†æå–å­—æ®µï¼Œé€šå¸¸ç›‘å¬ï¼š

### 1. **whereClause**

æ‰¾åˆ° WHERE å†…å®¹çš„èŒƒå›´ã€‚

### 2. **columnExpr / columnIdentifier**

è¯†åˆ«å­—æ®µåã€‚

---

# âœ… ä¸‰ã€å®ç°æ–¹å¼ï¼ˆListener æ¨¡å¼ï¼‰

## âœ¨æ€è·¯

* è¿›å…¥ `whereClause` æ—¶ï¼Œå¼€å¯æ ‡è®°ï¼š`inWhere = true`
* ç¦»å¼€ `whereClause` æ—¶å…³é—­æ ‡è®°ï¼š`inWhere = false`
* å¦‚æœæ­¤æ—¶å¤„äº WHERE å†…éƒ¨ï¼š

  * è¿›å…¥ `columnIdentifier` â†’ æå–å­—æ®µå
  * æˆ–è€…è¿›å…¥ `columnExpr` ä¸­çš„æ ‡è¯†ç¬¦

---

# âœ… å››ã€å¯ç”¨çš„ä»£ç ï¼ˆ100%å¯è¿è¡Œï¼Œåªä¾èµ–å®˜æ–¹è¯­æ³•ï¼‰

### **å­—æ®µæ”¶é›† Listenerï¼ˆæœ€æ¨èï¼‰**

```java
public class WhereFieldListener extends ClickHouseParserBaseListener {

    private boolean inWhere = false;

    // æœ€ç»ˆç»“æœï¼Œæ¯ä¸ªå…ƒç´ ï¼štable.field æˆ– field
    private final Set<String> fields = new HashSet<>();

    public Set<String> getFields() {
        return fields;
    }

    @Override
    public void enterWhereClause(ClickHouseParser.WhereClauseContext ctx) {
        inWhere = true;
    }

    @Override
    public void exitWhereClause(ClickHouseParser.WhereClauseContext ctx) {
        inWhere = false;
    }

    /**
     * columnIdentifier : identifier (DOT identifier)*
     */
    @Override
    public void enterColumnIdentifier(ClickHouseParser.ColumnIdentifierContext ctx) {
        if (!inWhere) return;

        // identifier (DOT identifier)*
        List<ClickHouseParser.IdentifierContext> ids = ctx.identifier();
        if (ids == null || ids.isEmpty()) return;

        String fullName = ids.stream()
                .map(ParseTree::getText)
                .collect(Collectors.joining("."));

        fields.add(fullName);
    }

    /**
     * æŸäº› columnExpr é‡Œä¹Ÿå¯èƒ½å‡ºç° å­—æ®µ
     */
    @Override
    public void enterColumnExprIdentifier(ClickHouseParser.ColumnExprIdentifierContext ctx) {
        if (!inWhere) return;

        String text = ctx.getText(); // å¯èƒ½æ˜¯ "table.field" æˆ– "field"
        fields.add(text);
    }
}
```

---

# âœ… äº”ã€å¦‚ä½•ä½¿ç”¨ Listener

```java
String sql = "SELECT a,b FROM t WHERE t.a = 1 AND b > 10";

ClickHouseLexer lexer = new ClickHouseLexer(CharStreams.fromString(sql));
CommonTokenStream tokens = new CommonTokenStream(lexer);
ClickHouseParser parser = new ClickHouseParser(tokens);

ParseTree tree = parser.query(); // æˆ– selectStmt() ç­‰

WhereFieldListener listener = new WhereFieldListener();
ParseTreeWalker.DEFAULT.walk(listener, tree);

System.out.println(listener.getFields());
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
[t.a, b]
```

---

# âœ… å…­ã€å¦‚æœä½ å¸Œæœ› `b` è‡ªåŠ¨å˜æˆ `t.b`

ClickHouse çš„å­—æ®µå¯èƒ½æ¥è‡ªï¼š

* æ˜ç¡®çš„ table.field
* æœªæŒ‡å®šè¡¨ï¼ˆå¯ä» FROM è·å–ï¼‰

è‹¥ä½ æƒ³è‡ªåŠ¨è¡¥å…¨ï¼š

1. åœ¨ Listener ä¸­åŒæ—¶æ”¶é›† `FROM` çš„è¡¨åˆ«åæ˜ å°„
2. æœªæŒ‡å®šè¡¨åçš„å­—æ®µ â†’ è‡ªåŠ¨è¡¥å…¨

æˆ‘å¯ä»¥ç»™ä½ å®Œæ•´å®ç°ï¼Œä½†è§ä½ ä¸šåŠ¡æ˜¯å¦éœ€è¦ã€‚

---

# ğŸ“Œ ä¸ƒã€ä½ é‡åˆ°çš„é—®é¢˜å¯¹åº”è§£é‡Š

| ä½ çš„é—®é¢˜                       | åŸå›                            |
| -------------------------- | ---------------------------- |
| `visitColumnExprDot` ä¸å­˜åœ¨   | ä½ çš„ .g4 æ–‡ä»¶ä¸æ˜¯æŸäº›æ–‡ç« ç‰ˆæœ¬            |
| `visitColumnExprField` ä¸å­˜åœ¨ | åŒä¸Š                           |
| åªæœ‰ `visitColumnExprList`   | è¯´æ˜ä½ é¡¹ç›®ç”¨çš„æ˜¯å®˜æ–¹è¯­æ³•                 |
| ä½ åªæœ‰ Listener               | å®Œå…¨å¤Ÿç”¨ï¼ŒListener æ›´é€‚åˆç›‘å¬ WHERE ç‰‡æ®µ |
| æƒ³è¦è¿”å›è¡¨å.å­—æ®µå                 | Listener é‡ŒæŠŠ identifier æ‹¼æ¥å³å¯  |

---

# ğŸ“£ å¦‚éœ€æˆ‘æä¾›ä»¥ä¸‹å†…å®¹æˆ‘éƒ½å¯ä»¥å†™ç»™ä½ ï¼š

* **å®Œæ•´ï¼šå­—æ®µ â†’ è¡¨åæ˜ å°„**
* **è‡ªåŠ¨è¡¥å…¨å­—æ®µçš„è¡¨å**
* **å¤„ç†å¤šè¡¨ join çš„å­—æ®µæ¥æº**
* **æ”¯æŒåµŒå¥—å­æŸ¥è¯¢ä¸­çš„ WHERE å­—æ®µæŠ½å–**
* **æ”¯æŒåˆ«åè§£æ a.b = c.d è‡ªåŠ¨å½’å±**

å‘Šè¯‰æˆ‘ä½ çš„ ClickHouse è¯­å¥ç»“æ„ï¼Œæˆ‘å¯ä»¥å®šåˆ¶æœ€åˆé€‚çš„ç‰ˆæœ¬ã€‚
