ä¸‹é¢ç»™ä½ ä¸€ä¸ª**ä¸ä¾èµ–ä½ ä¸å­˜åœ¨çš„æ–¹æ³•**ã€**å®Œå…¨åŸºäº ClickHouse å®˜æ–¹ ANTLR4 è¯­æ³•ç»“æ„**ã€å¹¶ä¸”ä½ **å½“å‰ç¡®å®åªæœ‰ ClickHouseParser + ClickHouseLexer + Listener** çš„æƒ…å†µä¸‹ï¼Œä¹Ÿèƒ½ç¨³ç¨³æå– **WHERE å­å¥æ‰€æœ‰å­—æ®µï¼ˆè¿”å› Set<table.field>ï¼‰** çš„é€šç”¨æ–¹æ¡ˆã€‚

> **é‡ç‚¹ï¼šClickHouse çš„è¯­æ³•é‡Œ â€œå­—æ®µè®¿é—®â€ å¹¶ä¸å« ColumnExprDotã€ColumnExprFieldï¼Œè¿™äº›éƒ½æ˜¯åˆ«å®¶ SQL è¯­æ³•çš„å‘½åã€‚
> ClickHouseParser.g4 ä½¿ç”¨çš„æ˜¯ç»Ÿä¸€çš„ ColumnExpr é€’å½’ç»“æ„ã€‚**

---

# âœ… **æœ€ç»ˆå¯ç”¨çš„è§£å†³æ–¹æ¡ˆï¼ˆåŸºäº Listenerï¼‰**

## **åŸç†ï¼šClickHouse çš„ ColumnExpr å­—æ®µè®¿é—®ç»“æ„å¦‚ä¸‹ï¼š**

* æ™®é€šå­—æ®µï¼š

  ```
  identifier
  ```
* è¡¨å.å­—æ®µï¼š

  ```
  columnExpr ('.' identifier)+
  ```
* å¸¦åå¼•å·ï¼š

  ```
  '`xxx`'
  ```

å­—æ®µåæœ€ç»ˆå‡ºç°åœ¨

```
tableIdentifier
identifier
```

ç­‰è§„åˆ™é‡Œï¼Œä¸åœ¨ ColumnExpr é‡Œç›´æ¥æä¾›ã€‚

---

# âœ… ä½ å¯ä»¥ç›‘å¬å¦‚ä¸‹èŠ‚ç‚¹ï¼š

### **1. è¿›å…¥ WHERE å­å¥ï¼švisitWhereClause / enterWhereClause**

è¯­æ³•é‡Œå«ï¼š

```
whereClause
    : WHERE columnExpr
```

### **2. åœ¨ WHERE å†…éå†æ‰€æœ‰ columnExprï¼Œæå–å­—æ®µå**

ä½ å¯ä»¥ç›‘å¬ï¼š

* `enterColumnExpr` â€”â€” ä½ è¯´æ²¡æœ‰ï¼Œé‚£å¯èƒ½æ˜¯ç”Ÿæˆçš„ Listener åç§°æ˜¯ï¼š
  `enterColumnExpr...` å…·ä½“å¯é€šè¿‡ IDE è‡ªåŠ¨è¡¥å…¨ç¡®è®¤

ä½ è‚¯å®šæœ‰å¦‚ä¸‹è¿™äº›ï¼ˆClickHouseParser.g4 ä¸­å­˜åœ¨ï¼‰ï¼š

| å¯èƒ½å‡ºç°çš„ ColumnExpr è§„åˆ™  | ç¤ºä¾‹         |
| -------------------- | ---------- |
| columnExprIdentifier | å­—æ®µåã€è¡¨åã€åˆ«å  |
| columnExprPrecedence | æ‰€æœ‰å¤æ‚è¡¨è¾¾å¼    |
| columnExprList       | å‡½æ•°ã€IN () ç­‰ |
| columnExprFunction   | å‡½æ•°è°ƒç”¨       |

**æ‰€ä»¥ä½ çš„æœ€ä½³æ–¹æ¡ˆæ˜¯ï¼šåœ¨ WHERE èŒƒå›´å†…é€’å½’æ‰«ææ‰€æœ‰ ColumnExprï¼Œæ‰¾åˆ°ä¸‹é¢ä¸¤ä¸ªè§„åˆ™ï¼š**

* **tableIdentifier**
* **identifier**

è¿™ä¸¤ä¸ªè§„åˆ™ä½ ä¸€å®šæœ‰ï¼ˆClickHouseParser.g4 åŸç‰ˆæä¾›ï¼‰ã€‚

---

# âœ… ç›´æ¥å¯è¿è¡Œçš„ Listener æ–¹æ¡ˆï¼ˆJavaï¼‰

```java
public class WhereFieldListener extends ClickHouseParserBaseListener {

    private boolean inWhere = false;
    private final Set<String> fields = new HashSet<>();

    @Override
    public void enterWhereClause(ClickHouseParser.WhereClauseContext ctx) {
        inWhere = true;
    }

    @Override
    public void exitWhereClause(ClickHouseParser.WhereClauseContext ctx) {
        inWhere = false;
    }

    @Override
    public void enterTableIdentifier(ClickHouseParser.TableIdentifierContext ctx) {
        if (!inWhere) return;

        // ctx.getText() = tableName
        currentTable = ctx.getText();
    }

    @Override
    public void enterIdentifier(ClickHouseParser.IdentifierContext ctx) {
        if (!inWhere) return;

        String id = ctx.getText();

        // æ˜¯å­—æ®µä½†ä¸æ˜¯è¡¨ï¼ˆå­—æ®µå‡ºç°åœ¨ ColumnExpr ä¸­ï¼‰
        if (isValidField(id)) {
            if (currentTable != null) {
                fields.add(currentTable + "." + id);
            } else {
                // æ— è¡¨åï¼šå¯èƒ½æ˜¯å•è¡¨æŸ¥è¯¢ -> UNKNOWN.id
                fields.add("UNKNOWN." + id);
            }
        }
    }

    private boolean isValidField(String id) {
        // æ’é™¤å…³é”®å­—ã€å‡½æ•°åç­‰ï¼ˆä½ å¯æ‹“å±•ï¼‰
        return !Character.isUpperCase(id.charAt(0)); 
    }

    public Set<String> getFields() {
        return fields;
    }
}
```

---

# â—å…³é”®ç‚¹è¯´æ˜ï¼ˆè§£å†³ä½ ç›®å‰çš„é—®é¢˜ï¼‰

## **1. ä½ æ²¡æœ‰ ColumnExprDot / ColumnExprField â†’ æ­£ç¡®**

ClickHouseParser.g4 é‡Œç¡®å®æ²¡æœ‰è¿™äº›ç»“æ„ã€‚

ğŸ‘‡å­—æ®µè®¿é—®ç»Ÿä¸€é•¿è¿™æ ·ï¼š

```
columnExpr: columnExpr '.' identifier
```

ANTLR ä¼šæŠŠå®ƒç¼–è¯‘æˆ
**ColumnExprContextï¼Œå†…éƒ¨ children æ˜¯ childExpr + '.' + identifier**
ä¸ä¼šç”Ÿæˆ ColumnExprDot è¿™ç§ contextã€‚

---

## **2. ä½ è¯´ â€œæ²¡æœ‰ enterColumnExprâ€ï¼Ÿ**

é‚£æ˜¯å› ä¸º ClickHouse è¯­æ³•æŠŠ ColumnExpr æ‹†æˆå¾ˆå¤šç‰‡æ®µï¼Œä¾‹å¦‚ï¼š

* enterColumnExprList
* enterColumnExprFunction
* enterColumnExprPrecedence
* enterColumnExprIdentifier
* enterColumnExprCase
* enterColumnExprArrayAccess

**Listener è¾“å‡ºæ–¹æ³•å…¨éƒ¨ç”±è§„åˆ™åè‡ªåŠ¨ç”Ÿæˆï¼Œå…·ä½“åå­—è¦çœ‹ g4 æ–‡ä»¶ã€‚**

ä½ åªè¦ï¼š

ğŸ‘‰ ç”¨ IDE æ‰“å¼€ ClickHouseParserBaseListener
æŸ¥æ‰¾æ‰€æœ‰åŒ…å« `ColumnExpr` çš„å›è°ƒ
ç„¶åè¦†ç›–ä½ éœ€è¦çš„å³å¯ã€‚

---

## **3. ä½ è¯´ â€œæ²¡æœ‰ ctx.identifierâ€ï¼Ÿ**

å¯¹ï¼ŒClickHouse è¯­æ³•é‡Œ identifier æ˜¯å•ç‹¬çš„è§„åˆ™ï¼š

```
identifier
    : IDENTIFIER
    | ...
```

ä½ è¦ç›‘å¬ `IdentifierContext` æ‰èƒ½è®¿é—®å­—æ®µåã€‚

---

# ğŸ”¥ æœ€æ¨èçš„åšæ³•ï¼ˆå‡†ç¡®åº¦æœ€é«˜ï¼‰

### **ç›‘å¬ Identifier + TableIdentifier â†’ è‡ªå·±æ‹¼æ¥**

è¿™æ˜¯æœ€é€šç”¨ã€æœ€ä¸ä¼šå‡ºé”™çš„æ–¹æ³•ã€‚

---

# å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ ï¼š

âœ” åŸºäºä½ å½“å‰çš„ ClickHouseParser.g4ï¼Œç”Ÿæˆå®Œæ•´å¯ç”¨çš„å­—æ®µæå–å™¨
âœ” å¸®ä½ å†™å¥½ Maven + ANTLR4 æ’ä»¶
âœ” æˆ–è€…åšä¸€ä¸ªç‹¬ç«‹å·¥å…·ç±» `ClickHouseWhereFieldExtractor`

åªéœ€æŠŠä½ çš„ ClickHouseParser.g4 å‰å‡ æ®µè§„åˆ™è´´ç»™æˆ‘ï¼Œæˆ‘å¯å¯¹ç—‡ä¸‹è¯ã€‚
