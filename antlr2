è¦åœ¨ç°æœ‰é¡¹ç›®é‡Œ **ä½¿ç”¨ ANTLR4 è§£æ ClickHouse æŸ¥è¯¢è¯­å¥ï¼Œå¹¶ä» WHERE å­å¥ä¸­æå–æ‰€æœ‰å­—æ®µå**ï¼Œä½ éœ€è¦æ ¹æ®é¡¹ç›®ç°çŠ¶é€‰æ‹© **â€œä¿®æ”¹åŸè¯­æ³•æ–‡ä»¶â€** æˆ– **â€œæ·»åŠ è‡ªå®šä¹‰ Listener/Visitor æ–‡ä»¶â€**ã€‚

ç»“è®ºéå¸¸æ˜ç¡®ï¼š

# âœ… **ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼šä¸éœ€è¦ä¿®æ”¹ ClickHouseLexer.g4 å’Œ ClickHouseParser.g4**

ä½ åº”è¯¥ **æ–°å¢ä¸€ä¸ª Visitor æˆ– Listener æ–‡ä»¶**ï¼Œåœ¨ WHERE å­å¥èŠ‚ç‚¹ä¸Šæ”¶é›†å­—æ®µã€‚

---

# ä¸ºä»€ä¹ˆä¸å»ºè®®æ”¹ Parser/Lexerï¼Ÿ

å› ä¸ºï¼š

* ClickHouse å®˜æ–¹è¯­æ³•æ–‡ä»¶éå¸¸å¤æ‚ï¼Œä»»ä½•ä¿®æ”¹éƒ½å¯èƒ½å¯¼è‡´è§£æå¼‚å¸¸ã€‚
* ä½ åªéœ€è¦â€œåˆ©ç”¨ ASTâ€ï¼Œä¸éœ€è¦æ”¹å˜è¯­æ³•ç»“æ„ã€‚
* è‡ªå®šä¹‰ Visitor æ˜¯ ANTLR çš„é€šç”¨æ–¹å¼ï¼Œç”¨æ¥ä»è¯­æ³•æ ‘æå–ä¿¡æ¯ã€‚

ğŸ‘‰ æ‰€ä»¥æ­£ç¡®åšæ³•æ˜¯ï¼š**æ–°å¢æ–‡ä»¶è§£æ WHERE å­å¥æå–å­—æ®µ**ã€‚

---

# ğŸ“Œ æ¨èç»“æ„ï¼ˆæ–°å¢æ–‡ä»¶å³å¯ï¼‰

ç›®å½•ç»“æ„ç¤ºä¾‹ï¼š

```
src/main/antlr/
    ClickHouseLexer.g4
    ClickHouseParser.g4

src/main/java/
    parser/
       ClickHouseWhereFieldVisitor.java   â† æ–°å¢è¿™ä¸ª
       ClickHouseParserUtil.java          â† å¯é€‰
```

---

# âœ¨ å¦‚ä½•ç¼–å†™ Visitor æå– WHERE å­—æ®µ

## 1. é¦–å…ˆç”Ÿæˆ ANTLR è§£æå™¨ï¼ˆå¦‚æœè¿˜æ²¡ç”Ÿæˆï¼‰

```bash
antlr4 ClickHouseLexer.g4 ClickHouseParser.g4 -visitor -package com.xxx.clickhouse.parser
```

---

## 2. æ–°å¢ä¸€ä¸ª Visitor æ–‡ä»¶ï¼ˆæ ¸å¿ƒï¼‰

### **ClickHouseWhereFieldVisitor.java**

```java
import java.util.*;
import com.xxx.clickhouse.parser.ClickHouseParser;
import com.xxx.clickhouse.parser.ClickHouseParserBaseVisitor;

public class ClickHouseWhereFieldVisitor extends ClickHouseParserBaseVisitor<Void> {

    private final Set<String> fields = new HashSet<>();

    public Set<String> getFields() {
        return fields;
    }

    @Override
    public Void visitColumnExprIdentifier(ClickHouseParser.ColumnExprIdentifierContext ctx) {
        // ctx.identifier() -> å­—æ®µå
        fields.add(ctx.getText());
        return null;
    }

    @Override
    public Void visitColumnExprDot(ClickHouseParser.ColumnExprDotContext ctx) {
        // è¡¨.å­—æ®µ ç»“æ„
        fields.add(ctx.getText());
        return null;
    }
}
```

---

# âœ¨ å¦‚ä½•è°ƒç”¨è§£æ where å®Œæ•´æµç¨‹ï¼ˆJavaï¼‰

ç¤ºä¾‹ï¼šè§£æä¸€å¥ SQLï¼š

```java
String sql = "SELECT a, b FROM table1 WHERE (age > 10 AND name = 'x') OR city = 'bj'";
```

å®Œæ•´ä»£ç ï¼š

```java
public static Set<String> parseWhereFields(String sql) {
    ClickHouseLexer lexer = new ClickHouseLexer(CharStreams.fromString(sql));
    CommonTokenStream tokens = new CommonTokenStream(lexer);
    ClickHouseParser parser = new ClickHouseParser(tokens);

    ClickHouseParser.QueryContext query = parser.query();

    ClickHouseParser.WhereClauseContext where = query.whereClause();

    if (where == null) {
        return Collections.emptySet();
    }

    ClickHouseWhereFieldVisitor visitor = new ClickHouseWhereFieldVisitor();
    visitor.visit(where);

    return visitor.getFields();
}
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
["age", "name", "city"]
```

---

# â“é‚£ä¹ˆä»€ä¹ˆæ—¶å€™è¦ä¿®æ”¹ ClickHouseLexer.g4 / Parser.g4ï¼Ÿ

ä»…å½“ï¼š

* ä½ éœ€è¦æ”¯æŒ ClickHouse è¯­æ³•æ–‡ä»¶æœªè¦†ç›–çš„æ–°åŠŸèƒ½
* æ¯”å¦‚æ–°è¯­æ³•ã€æ–°å…³é”®å­—ã€æ–°å‡½æ•°
* æˆ–è€… ClickHouseParser ç‰ˆæœ¬è¾ƒæ—§ï¼Œç¼ºå°‘æŸäº›è§„åˆ™

è¿™ç§æƒ…å†µä½ æ‰åº”è¯¥ä¿®æ”¹è¯­æ³•æ–‡ä»¶ã€‚

å¦åˆ™ **å®Œå…¨ä¸éœ€è¦åŠ¨å®ƒä»¬**ã€‚

---

# ğŸ“Œ æœ€ç»ˆç»“è®º

| éœ€æ±‚            | æ˜¯å¦éœ€è¦ä¿®æ”¹ g4 æ–‡ä»¶    |
| ------------- | --------------- |
| è§£æ WHERE å­å¥å­—æ®µ | âŒ ä¸éœ€è¦           |
| æ·»åŠ æ–°è¯­æ³•         | âœ” å¯èƒ½éœ€è¦          |
| ä¿®å¤è¯­æ³• bug      | âœ” å¯èƒ½éœ€è¦          |
| å•çº¯æå–åˆ—å        | âŒ æ–°å¢ Visitor å³å¯ |

ğŸ‘‰ **ä½ çš„éœ€æ±‚ï¼ˆæå–å­—æ®µï¼‰å±äºâ€œæ–°å¢ Visitorâ€å³å¯å®Œæˆã€‚**

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ï¼š

âœ” æ›¿ä½ å†™å®Œæ•´å¯è¿è¡Œçš„ Maven é¡¹ç›®ç»“æ„
âœ” å†™å®Œæ•´å·¥å…·ç±» + æµ‹è¯•ä»£ç 
âœ” å®ç°â€œé€’å½’å¤„ç†è¡¨è¾¾å¼â€ç‰ˆæœ¬
âœ” å®ç°â€œå»æ‰å‡½æ•°å‚æ•°å†…å­—æ®µâ€ç‰ˆæœ¬
âœ” å®ç°â€œå¸¦è¡¨åˆ«åè§£æçš„å­—æ®µæ ‘â€ç‰ˆæœ¬

éœ€è¦å“ªä¸ªï¼Ÿ
