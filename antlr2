ä¸‹é¢ç»™ä½ ä¸€ä»½**å¯ç›´æ¥åœ¨ç°æœ‰ ClickHouse ANTLR4 è¯­æ³•åŸºç¡€ä¸Šä½¿ç”¨çš„æ–¹æ¡ˆ**ï¼Œæ— éœ€ä¿®æ”¹ ClickHouseLexer.g4 / ClickHouseParser.g4ï¼Œåªéœ€è¦**æ–°å»ºä¸€ä¸ª Listener** æ¥æå– WHERE å­å¥ä¸­çš„å­—æ®µåã€‚

ä½ å½“å‰é‡åˆ°çš„é—®é¢˜æ˜¯ï¼š

* æ²¡æœ‰ `ColumnExprDotContext`
* æ²¡æœ‰ `ColumnExprFieldContext`
* æ²¡æœ‰ `visitColumnExpr`
* åªæœ‰å¤§é‡ `visitColumnExprXXX`
* ä½ åªæœ‰ **Listener** è€Œä¸æ˜¯ Visitor

è¿™äº›éƒ½æ˜¯ **ClickHouse å®˜æ–¹è¯­æ³•æœ¬èº«çš„ç»“æ„å†³å®šçš„**ï¼Œä¸æ˜¯ä½ ç”¨é”™äº†ã€‚

ClickHouse çš„å­—æ®µå®é™…ä¸Šå‡ºç°åœ¨ï¼š

* `columnExpr`ï¼ˆè¡¨è¾¾å¼èŠ‚ç‚¹ï¼‰
* `columnIdentifier`ï¼ˆå­—æ®µåèŠ‚ç‚¹ï¼‰
* `tableIdentifier`ï¼ˆè¡¨åèŠ‚ç‚¹ï¼‰

å­—æ®µåä¸è¡¨ååœ¨ grammar ä¸­æ˜¯åˆ†å¼€çš„ï¼Œä¸æ˜¯ â€œtable.fieldâ€ é‚£ç§ç»“æ„ã€‚

---

# âœ… ä¸€ã€WHERE å­—æ®µæ‰€åœ¨çš„çœŸå®èŠ‚ç‚¹

åœ¨ ClickHouseParser.g4 ä¸­ï¼š

### 1. where å­å¥

```g4
whereClause
    : WHERE columnExpr
    ;
```

### 2. columnExprï¼ˆå­—æ®µã€å‡½æ•°ã€æ“ä½œç¬¦ç­‰å…¨éƒ¨ä»è¿™é‡Œå¼€å§‹ï¼‰

å­—æ®µåä¸ä¼šæ˜¯ `ColumnExprDot`ï¼Œè€Œæ˜¯ï¼š

### 3. ClickHouse å­—æ®µæ ‡è¯†ç¬¦èŠ‚ç‚¹ï¼ˆé‡ç‚¹ï¼‰

```g4
columnIdentifier
    : identifier (DOT identifier)*
    ;
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ è¦æ‰¾çš„ç»“æ„æ˜¯ï¼š

* `columnIdentifier()`
* å®ƒå¯èƒ½æ˜¯ï¼š

  * `a`
  * `t.a`
  * `db.t.a`

---

# âœ… äºŒã€åªç”¨ Listener æå– WHERE å­—æ®µåï¼ˆæ— éœ€ä¿®æ”¹è¯­æ³•ï¼‰

ä½ å¯ä»¥ç›‘å¬ï¼š

1. **è¿›å…¥ WHERE å­å¥**
2. åœ¨ WHERE å­å¥å†…éƒ¨æ‰«æ `columnIdentifier`

---

## â­ æœ€æ¨èå®ç°ï¼šè‡ªå®šä¹‰ Listenerï¼ˆä¸æ”¹è¯­æ³•ï¼‰

### æ–°å»ºä¸€ä¸ªç±» `WhereFieldExtractor.java`

```java
public class WhereFieldExtractor extends ClickHouseParserBaseListener {

    private boolean inWhere = false;
    private final Set<String> fields = new HashSet<>();

    public Set<String> getFields() {
        return fields;
    }

    @Override
    public void enterWhereClause(ClickHouseParser.WhereClauseContext ctx) {
        inWhere = true;
    }

    @Override
    public void exitWhereClause(ClickHouseParser.WhereClauseContext ctx) {
        inWhere = false;
    }

    @Override
    public void enterColumnIdentifier(ClickHouseParser.ColumnIdentifierContext ctx) {
        if (inWhere) {
            // å­—æ®µå¯èƒ½æ˜¯ a æˆ– t.a æˆ– db.t.a
            String field = ctx.getText();
            fields.add(field);
        }
    }
}
```

---

# âœ… ä¸‰ã€ä½¿ç”¨æ–¹å¼ï¼ˆæ ¸å¿ƒä»£ç ï¼‰

```java
public static Set<String> extractWhereFields(String sql) {
    ClickHouseLexer lexer = new ClickHouseLexer(CharStreams.fromString(sql));
    ClickHouseParser parser = new ClickHouseParser(new CommonTokenStream(lexer));

    ParseTree tree = parser.selectUnionStmt();

    WhereFieldExtractor listener = new WhereFieldExtractor();
    ParseTreeWalker.DEFAULT.walk(listener, tree);

    return listener.getFields();
}
```

---

# âœ… å››ã€ç¤ºä¾‹

SQLï¼š

```sql
SELECT name FROM t WHERE age > 10 AND user.city = 'SZ'
```

å¾—åˆ°çš„å­—æ®µé›†åˆï¼š

```
age
user.city
```

---

# â— ä¸ºä»€ä¹ˆä½ æ‰¾ä¸åˆ° ColumnExprDot / ColumnExprFieldï¼Ÿ

å› ä¸º **ClickHouse å®˜æ–¹ grammar å¹¶ä¸å­˜åœ¨è¿™äº›èŠ‚ç‚¹**ï¼Œè€Œæ˜¯ï¼š

* è¡¨è¾¾å¼ï¼š`columnExpr`
* å­—æ®µï¼š`columnIdentifier`
* æ ‡è¯†ç¬¦ï¼š`identifier`

å­—æ®µçš„â€œç‚¹å·ç»“æ„ï¼ˆa.b.cï¼‰â€å®é™…ç”± `identifier (DOT identifier)*` ç»„æˆï¼Œè€Œä¸æ˜¯ Visitor è‡ªåŠ¨æ‹†æˆ Dot èŠ‚ç‚¹ã€‚

---

# âœ… äº”ã€å¦‚æœä½ æƒ³æå–æ‰€æœ‰è¡¨å + å­—æ®µåï¼ˆå¯é€‰ï¼‰

ç›‘å¬ `enterTableIdentifier`ï¼š

```java
@Override
public void enterTableIdentifier(ClickHouseParser.TableIdentifierContext ctx) {
    if (inWhere) {
        System.out.println("è¡¨å: " + ctx.getText());
    }
}
```

---

# ğŸ æ€»ç»“

### åªä½¿ç”¨ Listener æå– WHERE å­—æ®µï¼š

âœ” ç›‘å¬ `enterWhereClause / exitWhereClause`
âœ” ç›‘å¬ `enterColumnIdentifier`
âœ” è·å– `ctx.getText()` å³å¯

ä¸éœ€è¦ä¿®æ”¹åŸæœ‰ .g4 æ–‡ä»¶ï¼Œä¸éœ€è¦ Visitorï¼Œä¸éœ€è¦ ColumnExprDotã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ï¼š

ğŸ“Œ **ç»™ä½ å°è£…æˆ Spring Bean**
ğŸ“Œ **ç»™ä½ ç¼–å†™å•å…ƒæµ‹è¯• demo**
ğŸ“Œ **æ ¹æ®ä½ çš„ä¸šåŠ¡å°è£…æˆå·¥å…·ç±»**

è¦ä¸è¦æˆ‘å¸®ä½ æŠŠæ•´ä¸ªæå–å·¥å…·å°æˆä¸€ä¸ª `WhereFieldUtils.java`ï¼Ÿ
