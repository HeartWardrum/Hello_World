ä¸‹é¢æˆ‘å¸®ä½ **å½»åº•ææ¸…æ¥š ClickHouse çš„ ANTLR4 è¯­æ³•ç»“æ„ã€ä¸ºä»€ä¹ˆæ‰¾ä¸åˆ° ColumnExprDot / ColumnExprFieldã€åº”è¯¥å¦‚ä½•æ‰©å±•ç°æœ‰è¯­æ³•æ¥æå– WHERE å­å¥å­—æ®µ**ã€‚

---

# âœ… ä¸€ã€ä¸ºä»€ä¹ˆä½ çš„é¡¹ç›®é‡Œæ‰¾ä¸åˆ° `ColumnExprDotContext`ã€`ColumnExprFieldContext`ï¼Ÿ

å› ä¸º **ä½ é¡¹ç›®é‡Œçš„ ClickHouseLexer.g4 / ClickHouseParser.g4 æ–‡ä»¶å¹¶ä¸æ˜¯å®˜æ–¹è¯­æ³•æ–‡ä»¶**ã€‚

ClickHouse å®˜æ–¹ ANTLR4 è¯­æ³•ç‰ˆæœ¬ä¼—å¤šï¼Œå¤šæ•°ç¬¬ä¸‰æ–¹åº“ä½¿ç”¨çš„è¯­æ³• *ä¸ä¸€å®šåŒ…å« ColumnExprDot / ColumnExprField*ã€‚

ä¾‹å¦‚ï¼š

| è¯­æ³•æ¥æº               | ColumnExpr æ˜¯å¦æ‹†åˆ†ï¼Ÿ                                                          |
| ------------------ | ------------------------------------------------------------------------- |
| ClickHouse JDBC é©±åŠ¨ | **æ‹†åˆ†äº†** Fieldã€Dot ç­‰                                                       |
| éƒ¨åˆ† GitHub é¡¹ç›®æ—§ç‰ˆè¯­æ³•   | **æœªæ‹†åˆ†**ï¼Œä¸€ä¸ªå¤§ `columnExpr` è§„åˆ™åŒ…æ‹¬æ‰€æœ‰æƒ…å†µ                                         |
| ä½ çš„ç‰ˆæœ¬ï¼ˆå¸¸è§ï¼‰           | **columnExprListã€columnExprLiteralã€columnExprFunctionâ€¦** ç­‰ç­‰ï¼Œä½†æ²¡æœ‰ Dot/Field |

æ‰€ä»¥ä½ æ‰¾ä¸åˆ°æ˜¯æ­£å¸¸çš„ï¼Œéœ€è¦å…ˆç¡®è®¤ä½ è¯­æ³•é‡Œçš„å®é™…ç»“æ„ã€‚

---

# âœ… äºŒã€ä½ çš„è¯­æ³•é•¿ä»€ä¹ˆæ ·ï¼Ÿï¼ˆå…¸å‹ç»“æ„ï¼‰

æ ¹æ®ä½ è¯´çš„æƒ…å†µï¼Œä½ çš„ Parser å¯èƒ½ç±»ä¼¼ï¼š

```
columnExpr
    :   columnExprList
    |   columnExprFunction
    |   columnExprIdentifier
    |   columnExprLiteral
    |   ...
```

ğŸ“Œ **é‡ç‚¹ï¼šå­—æ®µä¸€èˆ¬æ˜¯ columnExprIdentifier**

ä¾‹å¦‚ï¼š

```
columnExprIdentifier
    : IDENTIFIER (DOT IDENTIFIER)*
```

å¾ˆå¤šè¯­æ³•æŠŠï¼š

```
table.column
```

ä¹Ÿå½’ä¸ºä¸€ä¸ªæ•´ä½“ï¼š

```
columnExprIdentifier â†’  "table.column"
```

è€Œä¸ä¼šç”Ÿæˆ "Dot" å­èŠ‚ç‚¹ã€‚

---

# âœ… ä¸‰ã€ä½ åº”è¯¥å¦‚ä½•æå– WHERE å­å¥ä¸­çš„å­—æ®µï¼Ÿ

### âœ¨ åšæ³•éå¸¸ç®€å•ï¼š

åªéœ€è¦è¦†ç›– `visitColumnExprIdentifier`

```java
@Override
public Void visitColumnExprIdentifier(ClickHouseParser.ColumnExprIdentifierContext ctx) {
    String text = ctx.getText();   // å¦‚ "a" æˆ– "table.a"
    fields.add(text);
    return null;
}
```

å¦‚æœä½ å¸Œæœ›æ‹†åˆ† `è¡¨.å­—æ®µ`ï¼š

```java
String raw = ctx.getText(); // table.column
String[] parts = raw.split("\\.");
if (parts.length == 2) {
    tableNames.add(parts[0]);
    fields.add(parts[1]);
} else {
    fields.add(raw);
}
```

---

# âœ… å››ã€WHERE å­å¥å¦‚ä½•è¿›å…¥ï¼Ÿ

è¯­æ³•ä¸€èˆ¬åŒ…å«ï¼š

```
whereClause
    : WHERE columnExpr
```

ä½ å¯é€šè¿‡ï¼š

```java
@Override
public Void visitWhereClause(ClickHouseParser.WhereClauseContext ctx) {
    return visit(ctx.columnExpr());
}
```

ç¡®ä¿éå† where å†…éƒ¨æ‰€æœ‰è¡¨è¾¾å¼ã€‚

---

# âœ… äº”ã€æ˜¯å¦éœ€è¦ä¿®æ”¹ ClickHouseParser.g4ï¼Ÿ

âŒ **å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä¸éœ€è¦ä¿®æ”¹ï¼**

åŸå› ï¼š

* å­—æ®µè§£æå·²ç»åœ¨ `columnExprIdentifier` ä¸­
* ä¸éœ€è¦é¢å¤–æ‹†åˆ† Dot ç»“æ„
* ä¿®æ”¹ g4 ä¼šå¢åŠ ç»´æŠ¤æˆæœ¬ï¼Œå¹¶éœ€è¦é‡æ–°ç”Ÿæˆ Lexer/Parser

åªæœ‰ä»¥ä¸‹æƒ…å†µæ‰éœ€è¦ä¿®æ”¹è¯­æ³•ï¼š

* ä½ å¿…é¡»åŒºåˆ†è¡¨åå’Œå­—æ®µåï¼ˆä¾‹å¦‚éœ€è¦ lineageï¼‰
* ä½ å¸Œæœ›ä¸º Dot ç»“æ„å•ç‹¬å®šä¹‰è§„åˆ™

ç›®å‰æ¥çœ‹ï¼Œ**ä½ å®Œå…¨ä¸éœ€è¦ä¿®æ”¹è¯­æ³•æ–‡ä»¶**ã€‚

---

# âœ… å…­ã€ä½ æƒ³æ‰¾çš„ visitor æ–¹æ³•åˆ—è¡¨æ€ä¹ˆæŸ¥çœ‹ï¼Ÿ

å¦‚æœä½ ä¸çŸ¥é“åº”è¯¥é‡å†™å“ªäº›ï¼Œå¯ä»¥æŸ¥çœ‹ï¼š

```
target/generated-sources/antlr4/ClickHouseParserBaseVisitor.java
```

é‡Œé¢æœ‰æ‰€æœ‰ `visitXxx` çš„æ–¹æ³•ã€‚

ä½ çœ‹åˆ°åªæœ‰ï¼š

```
visitColumnExprList
visitColumnExprFunction
visitColumnExprIdentifier
...
```

è¯´æ˜ *ä½ çš„è¯­æ³•å°±æ˜¯è¿™ä¹ˆè®¾è®¡çš„*ï¼Œæ²¡æœ‰å…¶ä»– Dot ç±»åˆ«çš„æ–¹æ³•ã€‚

---

# âœ… ä¸ƒã€å®Œæ•´ç¤ºä¾‹ï¼šæå– WHERE å­—æ®µ

```java
public class FieldVisitor extends ClickHouseParserBaseVisitor<Void> {

    private Set<String> fields = new HashSet<>();

    @Override
    public Void visitWhereClause(ClickHouseParser.WhereClauseContext ctx) {
        return visit(ctx.columnExpr());
    }

    @Override
    public Void visitColumnExprIdentifier(ClickHouseParser.ColumnExprIdentifierContext ctx) {
        String raw = ctx.getText();
        fields.add(raw);  // table.column æˆ– column
        return null;
    }

    public Set<String> getFields() {
        return fields;
    }
}
```

è°ƒç”¨ï¼š

```java
FieldVisitor visitor = new FieldVisitor();
visitor.visit(parseTree);
System.out.println(visitor.getFields());
```

---

# âœ… å…«ã€å¦‚æœä½ éœ€è¦ï¼Œæˆ‘å¯ä»¥å¸®ä½ è§£æä½ æ‰‹å¤´çš„ g4 æ–‡ä»¶

ä½ å¯ä»¥æŠŠï¼š

* ClickHouseLexer.g4
* ClickHouseParser.g4

å‘ç»™æˆ‘ï¼Œæˆ‘å¯ä»¥ï¼š

âœ” åˆ†æä½ è¯­æ³•ä¸­å­—æ®µè¡¨è¾¾å¼çš„å®é™…è§„åˆ™
âœ” ç²¾å‡†å‘Šè¯‰ä½ é‡å†™å“ªä¸ª visit æ–¹æ³•
âœ” å¦‚æœ‰å¿…è¦ï¼Œå¸®ä½ è¡¥å…… Dot è¡¨è¾¾å¼è§£æ

---

å¦‚æœä½ æ„¿æ„ï¼Œç°åœ¨å¯ä»¥æŠŠ **columnExprã€columnExprIdentifier** çš„ g4 ç‰‡æ®µè´´ç»™æˆ‘ï¼Œæˆ‘å¯ä»¥ç«‹å³ç¡®è®¤ä½ å­—æ®µå‡ºç°åœ¨å“ªä¸ªèŠ‚ç‚¹ã€‚
