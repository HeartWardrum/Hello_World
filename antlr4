ä¸‹é¢ç»™ä½ ä¸€å¥—**å®Œæ•´ã€å¯ç›´æ¥è½åœ°çš„æ–¹æ¡ˆ**ï¼ŒåŸºäº **JSqlParser 5.3**ï¼Œå®ç°ä»¥ä¸‹éœ€æ±‚ï¼š

> **è¾“å…¥ä¸€æ¡å¤æ‚ SQL â†’ è§£ææ‰€æœ‰æŸ¥è¯¢æ¡ä»¶ä¸­çš„å­—æ®µ â†’ ä¾æ®è¡¨å+å­—æ®µåæ¯”å¯¹æ•æ„Ÿå­—æ®µè¡¨ â†’ åˆ¤æ–­æ˜¯å¦å‘½ä¸­æ•æ„Ÿå­—æ®µã€‚**

å…¨ç¨‹ä½¿ç”¨ä¸­æ–‡ï¼Œå¹¶ç»™å‡º**Java ç¤ºä¾‹ä»£ç **ã€‚

---

# âœ… æ€»ä½“æ€è·¯

1. **ä½¿ç”¨ JSqlParser è§£æ SQL â†’ AST**
2. **æŠ½å– SQL ä¸­æ‰€æœ‰è¡¨ï¼ˆå«åˆ«åï¼‰**
3. **æŠ½å–æ‰€æœ‰ WHERE / JOIN æ¡ä»¶ä¸­çš„å­—æ®µï¼ˆColumnï¼‰**
4. **å°† Column çš„ â€œè¡¨å + å­—æ®µåâ€ æ˜ å°„ä¸ºçœŸå®è¡¨å**
5. **å»æ•°æ®åº“æˆ–æœ¬åœ°ç¼“å­˜æ£€æŸ¥æ•æ„Ÿå­—æ®µè¡¨**
6. **è¿”å›å‘½ä¸­æ•æ„Ÿå­—æ®µåˆ—è¡¨**

---

# ğŸ§© ç¤ºä¾‹å¤æ‚ SQL

å‡è®¾ SQL å¯èƒ½åƒè¿™æ ·ï¼š

```sql
SELECT a.id, b.phone
FROM user a
JOIN user_detail b ON a.id = b.user_id
WHERE a.name = 'Tom'
  AND (b.phone = '123456' OR b.idcard LIKE '%123%');
```

æˆ‘ä»¬è¦è§£æå‡ºï¼š

| è¡¨           | å­—æ®µ     |
| ----------- | ------ |
| user        | name   |
| user_detail | phone  |
| user_detail | idcard |

ç„¶åå†åˆ° `sensitive_fields` è¡¨åˆ¤æ–­æ˜¯å¦å±äºæ•æ„Ÿå­—æ®µã€‚

---

# ğŸ”§ JSqlParser 5.3 å®ç°

ä¸‹é¢ç»™ä½ ä¸€æ®µ**å¯è¿è¡Œçš„ Java ä»£ç ç¤ºä¾‹**ï¼Œé€‚ç”¨äº Spring Boot / å•å…ƒæµ‹è¯•ã€‚

## ğŸ‘‰ 1. è§£æ SQL

```java
Statement statement = CCJSqlParserUtil.parse(sql);
Select select = (Select) statement;
PlainSelect plainSelect = (PlainSelect) select.getSelectBody();
```

---

## ğŸ‘‰ 2. è·å–æ‰€æœ‰è¡¨ï¼ˆå«åˆ«åæ˜ å°„ï¼‰

```java
// key: åˆ«åæˆ–è¡¨åæœ¬èº«ï¼Œvalue: çœŸå®è¡¨å
Map<String, String> tableAliasMap = new HashMap<>();

FromItem fromItem = plainSelect.getFromItem();
handleFromItem(fromItem, tableAliasMap);

List<Join> joins = plainSelect.getJoins();
if (joins != null) {
    for (Join join : joins) {
        handleFromItem(join.getRightItem(), tableAliasMap);
    }
}
```

è¾…åŠ©æ–¹æ³•ï¼š

```java
private void handleFromItem(FromItem fromItem, Map<String, String> map) {
    if (fromItem instanceof Table) {
        Table table = (Table) fromItem;
        String tableName = table.getName();
        String alias = table.getAlias() != null ? table.getAlias().getName() : tableName;
        map.put(alias, tableName);
    }
}
```

---

## ğŸ‘‰ 3. æŠ½å– WHEREã€JOIN ON ä¸­æ‰€æœ‰å­—æ®µ

```java
Expression where = plainSelect.getWhere();
List<Column> columns = new ArrayList<>();
if (where != null) {
    where.accept(new ExpressionVisitorAdapter() {
        @Override
        public void visit(Column column) {
            columns.add(column);
        }
    });
}

// å¤„ç† JOIN çš„ ON è¡¨è¾¾å¼
if (joins != null) {
    for (Join join : joins) {
        Expression on = join.getOnExpression();
        if (on != null) {
            on.accept(new ExpressionVisitorAdapter() {
                @Override
                public void visit(Column column) {
                    columns.add(column);
                }
            });
        }
    }
}
```

---

## ğŸ‘‰ 4. å°† Column è½¬æ¢ä¸º (çœŸå®è¡¨å, å­—æ®µå)

è§£æå‡ºçš„å­—æ®µå¯èƒ½æ˜¯ï¼š

* `a.name`
* `b.phone`

éœ€è¦è½¬ä¸ºçœŸå®è¡¨åï¼š

```java
List<String> riskFields = new ArrayList<>();

for (Column column : columns) {
    String tableAlias = column.getTable() != null ? column.getTable().getName() : null;
    String field = column.getColumnName();

    // å¦‚æœ SQL ä¸­æœªå¸¦è¡¨å‰ç¼€ï¼Œå¯æŒ‰ä¸šåŠ¡è§„åˆ™å¤„ç†
    if (tableAlias == null) {
        continue;
    }

    String realTable = tableAliasMap.get(tableAlias);
    if (realTable == null) continue;

    // æ ¡éªŒæ•æ„Ÿå­—æ®µ
    if (isSensitive(realTable, field)) {
        riskFields.add(realTable + "." + field);
    }
}
```

---

## ğŸ‘‰ 5. æ¯”å¯¹æ•æ„Ÿå­—æ®µè¡¨ï¼ˆä¼ªä»£ç ï¼‰

```java
private boolean isSensitive(String table, String field) {
    // ç¤ºä¾‹ï¼šä½ å¯ä»¥æŸ¥æ•°æ®åº“æˆ–ä»ç¼“å­˜é‡Œå–
    return sensitiveFieldService.exists(table, field);
}
```

---

# ğŸ‰ æœ€ç»ˆç»“åˆç¤ºä¾‹ï¼šå®Œæ•´ä»£ç ç‰‡æ®µ

```java
public List<String> detectSensitiveFields(String sql) throws Exception {
    Statement statement = CCJSqlParserUtil.parse(sql);
    Select select = (Select) statement;
    PlainSelect plainSelect = (PlainSelect) select.getSelectBody();

    // 1. è§£æè¡¨åˆ«å
    Map<String, String> tableAliasMap = new HashMap<>();
    handleFromItem(plainSelect.getFromItem(), tableAliasMap);

    List<Join> joins = plainSelect.getJoins();
    if (joins != null) {
        for (Join join : joins) {
            handleFromItem(join.getRightItem(), tableAliasMap);
        }
    }

    // 2. æŠ½å–æ‰€æœ‰ Column
    List<Column> columns = new ArrayList<>();

    if (plainSelect.getWhere() != null) {
        plainSelect.getWhere().accept(new ExpressionVisitorAdapter() {
            @Override
            public void visit(Column column) {
                columns.add(column);
            }
        });
    }

    if (joins != null) {
        for (Join join : joins) {
            if (join.getOnExpression() != null) {
                join.getOnExpression().accept(new ExpressionVisitorAdapter() {
                    @Override
                    public void visit(Column column) {
                        columns.add(column);
                    }
                });
            }
        }
    }

    // 3. æ ¡éªŒæ•æ„Ÿå­—æ®µ
    List<String> result = new ArrayList<>();

    for (Column column : columns) {
        String tableAlias = column.getTable() != null ? column.getTable().getName() : null;
        if (tableAlias == null) continue;

        String realTable = tableAliasMap.get(tableAlias);
        String field = column.getColumnName();

        if (realTable != null && isSensitive(realTable, field)) {
            result.add(realTable + "." + field);
        }
    }

    return result;
}
```

---

# ğŸ§ª è¾“å‡ºç¤ºä¾‹

å¦‚æœæ•æ„Ÿå­—æ®µè¡¨ä¸­æœ‰ï¼š

| è¡¨å          | å­—æ®µå    |
| ----------- | ------ |
| user_detail | phone  |
| user_detail | idcard |

åˆ™ç»“æœï¼š

```json
[
  "user_detail.phone",
  "user_detail.idcard"
]
```

---

# ğŸ“Œ æ€§èƒ½å»ºè®®

* æ•æ„Ÿå­—æ®µè¡¨å»ºè®®ç¼“å­˜åˆ° `Map<String, Set<String>>`
* è§£æ SQL ç”¨ JSqlParser å¼€é”€ä¸å¤§ï¼ˆå•æ¬¡ 1â€“5msï¼‰
* WHEREã€JOINã€å­æŸ¥è¯¢éƒ½èƒ½ç”¨ above æ–¹å¼å¤„ç†
* å¦‚é‡å¤æ‚ UNIONï¼Œå¯ä»¥é€’å½’ SelectVisitorï¼ˆå¯æä¾›æ ·ä¾‹ï¼‰

---

å¦‚æœä½ éœ€è¦çš„è¯ï¼Œæˆ‘ä¹Ÿå¯ä»¥ï¼š

âœ… å†ç»™å‡º **æ”¯æŒå­æŸ¥è¯¢ / UNION / WITH çš„å®Œæ•´é€šç”¨ç‰ˆè§£æå™¨**
âœ… å¸®ä½ å°è£…ä¸€ä¸ª **æ•æ„Ÿ SQL æ£€æŸ¥å™¨å·¥å…·ç±»ï¼ˆJava å¯ç›´æ¥å¤ç”¨ï¼‰**
âœ… è¾“å‡º **Spring Boot + MySQL æ•æ„Ÿå­—æ®µè¡¨ Demo**

éœ€è¦å—ï¼Ÿ
