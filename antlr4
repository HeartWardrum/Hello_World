ä¸‹é¢ç»™ä½ ä¸€ä¸ª**å¯ç›´æ¥ä¸Šæ‰‹çš„æ€è·¯å’Œç¤ºä¾‹**ï¼Œä½¿ç”¨ **ANTLR 4.13.2** å¯¹ SQL è¯­å¥è¿›è¡Œè§£æï¼Œç„¶ååˆ¤æ–­æŸ¥è¯¢æ¡ä»¶ï¼ˆWHERE å­å¥ï¼‰ä¸­æ˜¯å¦åŒ…å«æ•æ„Ÿæ•°æ®é¡¹ã€‚

---

# âœ… æ€»ä½“æ€è·¯

1. **ä½¿ç”¨ ANTLR4 è§£æ SQL**
   å¯ä»¥ç”¨å®˜æ–¹çš„ **TSQL / MySQL / PL/SQL / PostgreSQL** è¯­æ³•ï¼ˆGitHub ç°æˆï¼‰ï¼Œæˆ–åªæ ¹æ®ä½ çš„åœºæ™¯å®šåˆ¶ä¸€ä¸ªç®€åŒ–ç‰ˆ SQL è¯­æ³•ã€‚

2. **ç¼–å†™ Listener / Visitor**
   é‡ç‚¹ç›‘å¬ï¼š

   * æ¯”è¾ƒè¡¨è¾¾å¼ï¼š`col = xxx`
   * å­—æ®µå¼•ç”¨ï¼š`columnName`
   * æ¡ä»¶ç»„åˆï¼š`AND / OR`

3. **æ•æ„Ÿå­—æ®µåˆ—è¡¨**ï¼ˆä¾‹å¦‚ï¼‰

   ```java
   Set<String> sensitiveColumns = Set.of("id_card", "mobile", "email", "bank_no");
   ```

4. **åœ¨è§£ææ ‘ä¸­æ£€æŸ¥ WHERE å­å¥**æ˜¯å¦ä½¿ç”¨äº†æ•æ„Ÿå­—æ®µã€‚

---

# âœ… æ–¹æ¡ˆç¤ºä¾‹ï¼ˆANTLR4 + Javaï¼‰

ä¸‹é¢æ˜¯ä¸€ä¸ª**å¯è¿è¡Œçš„æœ€å°åŒ–è§£å†³æ–¹æ¡ˆ**ï¼Œé€‚åˆä½ çš„åœºæ™¯åˆ¤æ–­ SQL æ˜¯å¦åŒ…å«æ•æ„Ÿå­—æ®µã€‚

---

# 1ï¸âƒ£ ANTLR4 è¯­æ³•ï¼ˆç®€åŒ– SQLï¼‰

æ–‡ä»¶åï¼š`SimpleSql.g4`

```antlr
grammar SimpleSql;

parse
    : selectStmt EOF
    ;

selectStmt
    : SELECT selectElements FROM tableName whereClause?
    ;

selectElements
    : '*'
    | columnName (',' columnName)*
    ;

whereClause
    : WHERE expr
    ;

expr
    : expr AND expr
    | expr OR expr
    | predicate
    ;

predicate
    : columnName comparator literal
    ;

columnName
    : ID
    ;

tableName
    : ID
    ;

comparator
    : '=' | '>' | '<' | '>=' | '<=' | '<>'
    ;

literal
    : STRING
    | NUMBER
    ;

SELECT : 'SELECT';
FROM : 'FROM';
WHERE : 'WHERE';
AND : 'AND';
OR : 'OR';

ID : [a-zA-Z_][a-zA-Z0-9_]*;
NUMBER : [0-9]+;
STRING : '\'' (~['\r\n])* '\'';

WS : [ \t\r\n]+ -> skip;
```

> æ³¨æ„ï¼šè¿™æ˜¯ç¤ºä¾‹è¯­æ³•ï¼Œå¯æ ¹æ®ä½ å®é™… SQL å¤æ‚åº¦æ‰©å±•ã€‚

---

# 2ï¸âƒ£ Java å®ç° â€” ä½¿ç”¨ Visitor æ£€æŸ¥æ•æ„Ÿå­—æ®µ

```java
import org.antlr.v4.runtime.*;
import org.antlr.v4.runtime.tree.*;

import java.util.HashSet;
import java.util.Set;

public class SensitiveSqlChecker {

    // è‡ªå®šä¹‰æ•æ„Ÿå­—æ®µ
    private static final Set<String> SENSITIVE_COLUMNS = Set.of(
            "id_card", "mobile", "email", "bank_no"
    );

    public static boolean containsSensitiveCondition(String sql) {
        // 1. æ„å»º ANTLR è¾“å…¥æµ
        CharStream input = CharStreams.fromString(sql);

        // 2. è¯æ³•åˆ†æ
        SimpleSqlLexer lexer = new SimpleSqlLexer(input);
        CommonTokenStream tokens = new CommonTokenStream(lexer);

        // 3. è¯­æ³•åˆ†æ
        SimpleSqlParser parser = new SimpleSqlParser(tokens);
        ParseTree tree = parser.parse();

        // 4. è®¿é—® WHERE å­æ ‘
        SensitiveVisitor visitor = new SensitiveVisitor();
        visitor.visit(tree);

        return visitor.hasSensitive;
    }

    // è‡ªå®šä¹‰ Visitor
    static class SensitiveVisitor extends SimpleSqlBaseVisitor<Void> {

        boolean hasSensitive = false;

        @Override
        public Void visitPredicate(SimpleSqlParser.PredicateContext ctx) {
            if (ctx.columnName() != null) {
                String col = ctx.columnName().getText().toLowerCase();
                if (SensitiveSqlChecker.SENSITIVE_COLUMNS.contains(col)) {
                    hasSensitive = true;
                }
            }
            return super.visitPredicate(ctx);
        }
    }

    // æµ‹è¯•
    public static void main(String[] args) {
        String sql = "SELECT name, age FROM user WHERE mobile = '18812345678' AND age > 18";

        boolean result = containsSensitiveCondition(sql);
        System.out.println("æ˜¯å¦åŒ…å«æ•æ„Ÿæ•°æ®æ¡ä»¶: " + result);
    }
}
```

---

# 3ï¸âƒ£ ç¤ºä¾‹è¿è¡Œç»“æœ

è¾“å…¥ï¼š

```sql
SELECT name FROM user WHERE mobile = '18888888888'
```

è¾“å‡ºï¼š

```
æ˜¯å¦åŒ…å«æ•æ„Ÿæ•°æ®æ¡ä»¶: true
```

---

# 4ï¸âƒ£ å¦‚æœä½ çš„ SQL éå¸¸å¤æ‚ï¼Ÿ

æˆ‘å¯ä»¥å¸®ä½ å®ç°ï¼š

âœ… MySQL å®Œæ•´è¯­æ³•ï¼ˆå®˜æ–¹ ANTLRï¼‰
âœ… æ”¯æŒå¤æ‚ WHERE
âœ… æ”¯æŒå‡½æ•°è¡¨è¾¾å¼
âœ… æ”¯æŒåµŒå¥—å­æŸ¥è¯¢
âœ… æ”¯æŒ JOIN æ¡ä»¶è¯†åˆ«æ•æ„Ÿå­—æ®µ
âœ… æ”¯æŒå‚æ•°åŒ– SQLï¼ˆ? æˆ– :nameï¼‰

å‘Šè¯‰æˆ‘ä½ çš„ SQL ç±»å‹ï¼ˆMySQL / PostgreSQL / Oracle / SQL Serverï¼‰ï¼Œæˆ‘å¯ä»¥å¸®ä½ ï¼š

**ç”Ÿæˆå®Œæ•´å¯ç”¨çš„ ANTLR4 è¯­æ³• + Java æ ¡éªŒå™¨**ã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¸®ä½ ï¼š

ğŸ”§ æ ¹æ®ä½ ç°æœ‰çš„æ•æ„Ÿå­—æ®µåˆ—è¡¨è‡ªåŠ¨ç”Ÿæˆæ£€æµ‹å™¨
ğŸ”§ è¾“å‡ºå‘½ä¸­å­—æ®µåˆ—è¡¨è€Œä¸æ˜¯ true/false
ğŸ”§ æ”¯æŒè„±æ•ç­–ç•¥ï¼ˆå¦‚ä¸å…è®¸å‡ºç°åœ¨ WHEREï¼‰

éœ€è¦æˆ‘ç»§ç»­æ‰©å±•å—ï¼Ÿ
