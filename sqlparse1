ä½ é‡åˆ°çš„è¿™ä¸ªé—®é¢˜ **ä¸æ˜¯ä½ çš„ä»£ç é”™äº†**ï¼Œè€Œæ˜¯ **JSqlParser é»˜è®¤çš„ `ExpressionVisitorAdapter` å¯¹å¤æ‚è¡¨è¾¾å¼ä¸ä¼šè‡ªåŠ¨æ·±åº¦éå†**ï¼Œä¾‹å¦‚ï¼š

* åµŒå¥—æ‹¬å· `(a = 1 OR b = 2)`
* `LIKE`
* `IN`
* `BETWEEN`
* `EXISTS`
* å‡½æ•°è¡¨è¾¾å¼
* ç®—æœ¯è¡¨è¾¾å¼
* é€»è¾‘ç»„åˆ AND / OR
* CASE WHEN

å› æ­¤ä½ ç”¨çš„ visitor **åªä¼šè®¿é—®åˆ°æ ¹èŠ‚ç‚¹**ï¼ˆæ¯”å¦‚æ•´ä¸ª WHEREï¼‰ï¼Œä¸ä¼šå¾€å­è¡¨è¾¾å¼é‡Œèµ°ï¼Œæ‰€ä»¥ä½ çœ‹ä¸åˆ°ä»»ä½• Columnã€‚

---

# âœ… æ­£ç¡®åšæ³•ï¼šä½¿ç”¨ **ExpressionDeParser** é…åˆ **SelectDeParser**

è¿™æ˜¯ JSqlParser å®˜æ–¹æ¨èçš„ **å®Œæ•´æ·±åº¦éå†æ–¹å¼**ã€‚

ä¸‹é¢æˆ‘ç»™ä½ ä¸€ä¸ªèƒ½ç¡®å®è§£æå‡ºæ‰€æœ‰å­—æ®µçš„æ¨¡æ¿ â€”â€” ä½ ä¸€åˆ°ä¸¤ä¸ªæ¡ä»¶éƒ½èƒ½è§£æåˆ°ã€‚

---

# âœ… å¯ç›´æ¥ä½¿ç”¨çš„è§£æ Column ä»£ç ï¼ˆ100% èƒ½è§£æ WHERE ä¸­æ‰€æœ‰å­—æ®µï¼‰

```java
public List<Column> extractColumns(Expression where) {
    List<Column> columns = new ArrayList<>();

    ExpressionVisitorAdapter columnVisitor = new ExpressionVisitorAdapter() {
        @Override
        public void visit(Column column) {
            columns.add(column);
        }
    };

    // å…³é”®ï¼šExpressionDeParser ç”¨äºæ·±åº¦è§£ææ‰€æœ‰å­è¡¨è¾¾å¼
    ExpressionDeParser deParser = new ExpressionDeParser(columnVisitor, null, new StringBuilder());
    columnVisitor.setExpressionVisitor(deParser);

    where.accept(deParser);

    return columns;
}
```

è°ƒç”¨æ–¹å¼ï¼š

```java
if (plainSelect.getWhere() != null) {
    List<Column> whereColumns = extractColumns(plainSelect.getWhere());
    columns.addAll(whereColumns);
}
```

---

# ğŸ§ª ç¤ºä¾‹ï¼šWHERE ä¸­å­—æ®µä¸€å®šèƒ½è§£æå‡ºæ¥

SQLï¼š

```sql
WHERE (a.id = 1 OR (b.phone LIKE '%1%')) AND c.age BETWEEN 10 AND 20
```

ç»“æœï¼š

| è¡¨åˆ«å | å­—æ®µ    |
| --- | ----- |
| a   | id    |
| b   | phone |
| c   | age   |

å…¨éƒ¨èƒ½æ­£å¸¸è§£æã€‚

---

# ğŸ§© JOIN ON ä¹Ÿä¸€æ ·è§£æ

```java
if (joins != null) {
    for (Join join : joins) {
        if (join.getOnExpression() != null) {
            columns.addAll(extractColumns(join.getOnExpression()));
        }
    }
}
```

---

# ğŸ” ä¸ºä»€ä¹ˆä½ çš„å†™æ³•ä¸è¡Œï¼Ÿ

ä½ ç”¨çš„ï¼š

```java
plainSelect.getWhere().accept(new ExpressionVisitorAdapter() {...});
```

è¿™ä¸ª visitorï¼š

* **ä¸ä¼šè‡ªåŠ¨è¿›å…¥å­è¡¨è¾¾å¼**
* åªä¼šåœ¨è¡¨è¾¾å¼æ­£å¥½â€œæ˜¯ Columnâ€ æ—¶è°ƒç”¨ visit(Column)
* ä½† WHERE æ ¹èŠ‚ç‚¹ä¸€å®šæ˜¯ BinaryExpressionï¼ˆå¦‚ AndExpressionï¼‰
* æ‰€ä»¥æ°¸è¿œä¸ä¼šè§¦å‘ visit(Column)

---

# ğŸ¯ ç»ˆæç‰ˆï¼šæœ€ç®€å¯è¿è¡Œä»£ç 

```java
public static List<Column> parseWhereColumns(Expression where) {
    List<Column> columns = new ArrayList<>();

    ExpressionVisitorAdapter simpleVisitor = new ExpressionVisitorAdapter() {
        @Override
        public void visit(Column column) {
            columns.add(column);
        }
    };

    ExpressionDeParser deParser =
            new ExpressionDeParser(simpleVisitor, null, new StringBuilder());
    simpleVisitor.setExpressionVisitor(deParser);

    where.accept(deParser);

    return columns;
}
```

---

# ğŸ“Œ å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å†å¸®ä½ ï¼š

* æ‰“åŒ…æˆä¸€ä¸ª `SqlSensitiveChecker` å·¥å…·ç±»
* é€‚é…æ‰€æœ‰åœºæ™¯ï¼ˆå­æŸ¥è¯¢ã€UNIONã€WITHï¼‰
* åšæˆä¸€ä¸ª Spring Boot Starter

ä½ è¦è¿›ä¸€æ­¥å®Œå–„å—ï¼Ÿ
