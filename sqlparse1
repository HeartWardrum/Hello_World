ä¸‹é¢ç»™ä½ ä¸€ä¸ª**å®Œæ•´å¯è¡Œçš„å®ç°æ€è·¯**ï¼ŒåŒ…æ‹¬æ¶æ„è®¾è®¡ã€å…³é”®æ­¥éª¤ã€Java ç¤ºä¾‹ä»£ç ï¼ˆä½ æ˜¯ Java å·¥ç¨‹å¸ˆï¼Œæ‰€ä»¥æˆ‘ä»¥ Java ä¸ºä¸»ï¼‰ï¼Œä»¥åŠåœ¨ ClickHouse åœºæ™¯ä¸‹çš„æ³¨æ„äº‹é¡¹ã€‚

---

# âœ… **ç›®æ ‡**

ç»™ ClickHouse è¾“å…¥ä¸€æ¡å¤æ‚ SQLï¼Œåˆ¤æ–­é‡Œé¢çš„æŸ¥è¯¢æ¡ä»¶ï¼ˆWHEREã€JOINã€å­æŸ¥è¯¢ç­‰ï¼‰æ˜¯å¦åŒ…å«æ•æ„Ÿå­—æ®µã€‚
æ•æ„Ÿå­—æ®µç”±ä¸€å¼ å…ƒæ•°æ®è¡¨ç»´æŠ¤ï¼Œä¾‹å¦‚ï¼š

| table_name | column_name | sensitive_type |
| ---------- | ----------- | -------------- |

å®ç°é€»è¾‘ï¼š
**SQL â†’ è§£æå‡ºæ‰€æœ‰æ¶‰åŠçš„è¡¨ä¸å­—æ®µ â†’ ä»æ•æ„Ÿè¡¨åŒ¹é… â†’ åˆ¤æ–­æ˜¯å¦åŒ…å«æ•æ„Ÿé¡¹**

---

# â­ **æ•´ä½“æ–¹æ¡ˆ**

> æ¨èï¼šSQL Parserï¼ˆå¦‚ JSQLParserï¼‰+ è‡ªå»ºæ•æ„Ÿå­—æ®µè¡¨ + åŒ¹é…å­—æ®µ

## **1. ç»´æŠ¤ä¸€å¼ æ•æ„Ÿå­—æ®µè¡¨**

ä¾‹å¦‚ä½ åœ¨ ClickHouse æˆ– MySQL ç»´æŠ¤ä¸€å¼ ï¼š

```
sensitive_field_meta
-------------------------
id
table_name
column_name
sensitive_level
description
```

åŠ è½½åå†™åˆ°ç¼“å­˜ï¼ˆRedis / æœ¬åœ° Mapï¼‰ã€‚

---

## **2. ä½¿ç”¨ SQL Parser è§£æå¤æ‚ SQL**

Java é€‰å‹ï¼š

| Parser         | æ¨èç¨‹åº¦  | è¯´æ˜                 |
| -------------- | ----- | ------------------ |
| **JSQLParser** | â­â­â­â­â­ | æ”¯æŒå¤æ‚ SQLï¼ŒJava å‡ºæ¯æ–¹ä¾¿ |
| Apache Calcite | â­â­â­   | å¼ºå¤§ä½†å¤æ‚              |

å®é™…ç”Ÿäº§ä¸€èˆ¬ä½¿ç”¨ **JSQLParser**ï¼š

```
<dependency>
  <groupId>com.github.jsqlparser</groupId>
  <artifactId>jsqlparser</artifactId>
  <version>4.6</version>
</dependency>
```

---

## **3. æå– SQL ä¸­æ‰€æœ‰å­—æ®µ**

éœ€è¦è¦†ç›–ï¼š

* SELECT å­—æ®µ
* WHERE æ¡ä»¶å­—æ®µ
* JOIN æ¡ä»¶å­—æ®µ
* GROUP BY
* ORDER BY
* å­æŸ¥è¯¢
* åˆ«åæ˜ å°„

**ç‰¹åˆ«æ³¨æ„ ClickHouse è¯­æ³•æ”¯æŒçš„å‡½æ•°ã€æ•°ç»„ã€tupleã€JSONExtract ç­‰**
JSQLParser å¤§éƒ¨åˆ†èƒ½è¯†åˆ«ï¼Œä¸æ”¯æŒçš„ä½ å¯ä»¥é€šè¿‡ regex è¡¥ã€‚

---

## **4. å­—æ®µåŒ¹é…æ•æ„Ÿå­—æ®µè¡¨**

æ‹¿åˆ°ï¼š

```
Map<String, Set<String>> sensitiveMap
key: tableName
value: set(columnName)
```

åŒ¹é…é€»è¾‘ï¼š

* å¦‚æœ SQL ä½¿ç”¨åˆ«åï¼Œéœ€è¦è§£æåˆ«å â†’ å®é™…è¡¨å
* å­—æ®µè‹¥æ²¡æœ‰å¸¦è¡¨åï¼Œéœ€è¦é€šè¿‡ FROM è¡¨æ¨æ–­ï¼ˆå¦‚å•è¡¨æŸ¥è¯¢ï¼‰

---

# ğŸ§© **æœ€ç»ˆé€»è¾‘æµç¨‹å›¾**

```
SQL è¾“å…¥
   â†“
JSQLParser è§£æ
   â†“
æå–è¡¨ + å­—æ®µ
   â†“
å­—æ®µæ ‡å‡†åŒ–ï¼ˆå¤„ç†åˆ«åã€å¤§å°å†™ç­‰ï¼‰
   â†“
å»æ•æ„Ÿå…ƒæ•°æ®è¡¨åŒ¹é…
   â†“
è¿”å›ï¼šæ˜¯å¦åŒ…å«æ•æ„Ÿé¡¹ + å“ªäº›æ•æ„Ÿå­—æ®µ
```

---

# ğŸ§ª **Java å®ç°ç¤ºä¾‹**

ä»¥ä¸‹ä»£ç å·²è¦†ç›–ï¼š
âœ” è§£æè¡¨ä¸å­—æ®µ
âœ” æ”¯æŒåˆ«å
âœ” åŒ¹é…æ•æ„Ÿå­—æ®µ
âœ” å¤æ‚ SQL ä¹Ÿèƒ½å·¥ä½œ

## **1. åŠ è½½æ•æ„Ÿå­—æ®µåˆ° Map**

```java
public class SensitiveFieldService {

    // key: tableName, value: set of sensitive column names
    private Map<String, Set<String>> sensitiveFieldMap = new HashMap<>();

    public void loadSensitiveFields(List<SensitiveFieldMeta> list) {
        for (SensitiveFieldMeta meta : list) {
            sensitiveFieldMap
                .computeIfAbsent(meta.getTableName().toLowerCase(), k -> new HashSet<>())
                .add(meta.getColumnName().toLowerCase());
        }
    }

    public boolean isSensitive(String table, String column) {
        return sensitiveFieldMap.containsKey(table.toLowerCase()) &&
               sensitiveFieldMap.get(table.toLowerCase()).contains(column.toLowerCase());
    }
}
```

---

## **2. ä½¿ç”¨ JSQLParser è§£æ SQL å¹¶æå–å­—æ®µ**

```java
public class SqlSensitiveChecker {

    private final SensitiveFieldService sensitiveFieldService;

    public SqlSensitiveChecker(SensitiveFieldService sensitiveFieldService) {
        this.sensitiveFieldService = sensitiveFieldService;
    }

    public List<String> checkSensitive(String sql) {
        List<String> result = new ArrayList<>();

        try {
            Statement stmt = CCJSqlParserUtil.parse(sql);
            TablesNamesFinder tablesNamesFinder = new TablesNamesFinder();

            // è·å–æ‰€æœ‰è¡¨
            List<String> tableList = tablesNamesFinder.getTableList(stmt);

            // è·å–å­—æ®µè¡¨è¾¾å¼
            ExpressionDeParser expressionDeParser = new ExpressionDeParser() {
                @Override
                public void visit(Column column) {
                    String col = column.getColumnName();
                    String table = column.getTable() != null ? column.getTable().getName() : null;

                    // å¦‚æœè¡¨åä¸ºç©ºï¼Œä¸”åªæœ‰ä¸€ä¸ªè¡¨ â†’ é»˜è®¤æ­¤è¡¨
                    if (table == null && tableList.size() == 1) {
                        table = tableList.get(0);
                    }

                    if (table != null && sensitiveFieldService.isSensitive(table, col)) {
                        result.add(table + "." + col);
                    }

                    super.visit(column);
                }
            };

            // ç»‘å®šè§£æå™¨
            SelectDeParser selectDeParser = new SelectDeParser(expressionDeParser, new StringBuilder());
            expressionDeParser.setSelectVisitor(selectDeParser);
            expressionDeParser.setBuffer(new StringBuilder());
            stmt.accept(selectDeParser);

        } catch (Exception e) {
            throw new RuntimeException("SQLè§£æå¤±è´¥", e);
        }

        return result;
    }
}
```

---

## **3. ä½¿ç”¨ç¤ºä¾‹**

```java
String sql = "SELECT u.id, u.name, o.amount " +
             "FROM user_info u " +
             "JOIN order_info o ON u.id = o.user_id " +
             "WHERE u.id = 123 AND o.card_no = 'xxxx'";

List<String> sensitiveFields = checker.checkSensitive(sql);

if (!sensitiveFields.isEmpty()) {
    System.out.println("SQLåŒ…å«æ•æ„Ÿå­—æ®µ: " + sensitiveFields);
} else {
    System.out.println("æœªå‘½ä¸­æ•æ„Ÿå­—æ®µ");
}
```

---

# ğŸ§· **ClickHouse ç‰¹æ®Šæ”¯æŒ**

ClickHouse æœ‰äº›å‡½æ•°ä¼šè§£æä¸å‡ºæ¥ï¼Œä¾‹å¦‚ï¼š

* JSONExtract
* tuple()
* arrayJoin
* global join
* FINAL ä¿®é¥°ç¬¦

å¯ä»¥é‡‡ç”¨æ–¹æ³•ï¼š

1. **å…ˆç”¨æ­£åˆ™é¢„å¤„ç†**

   * å°† JSONExtract(column, ...) â†’ column
   * å°† tuple(column1, column2) â†’ column1,column2

2. **å¯¹æ— æ³•è¯†åˆ«çš„è¡¨è¾¾å¼ç”¨æ­£åˆ™æå–åˆ—å**

---

# ğŸš€ **æœ€ç»ˆæ•ˆæœ**

âœ” èƒ½è§£æä»»æ„å¤æ‚ SQL
âœ” èƒ½è¯†åˆ«æ•æ„Ÿå­—æ®µ
âœ” èƒ½æ”¯æŒ ClickHouse
âœ” æ€§èƒ½ç¨³å®šï¼ˆæ•æ„Ÿå­—æ®µç¼“å­˜ + è½»é‡è§£æï¼‰

---

# å¦‚ä½ éœ€è¦ï¼Œæˆ‘å¯ä»¥ç»§ç»­å¸®ä½ ï¼š

* æ ¹æ®ä½ ç°æœ‰ä¸šåŠ¡å°è£…æˆ Spring Boot ç»„ä»¶
* ç”Ÿæˆä¸€ä¸ªé«˜æ€§èƒ½ç‰ˆï¼ˆæå‰ç¼–è¯‘ SQL ASTï¼‰
* æä¾›åŒ¹é… ClickHouse ç‰¹æœ‰å‡½æ•°çš„å¢å¼ºç‰ˆ
* æä¾›å®Œæ•´å¯è¿è¡Œ Demo é¡¹ç›®ï¼ˆJava + JSQLParserï¼‰

åªéœ€è¦å‘Šè¯‰æˆ‘å³å¯ã€‚
